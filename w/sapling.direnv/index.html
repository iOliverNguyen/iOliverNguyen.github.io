<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Make sapling work with direnv | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Make sapling work with direnv"><meta property="og:description" content="In the last post, I shared my experience with Sapling, Meta’s new Git client. It requires some workaround with direnv. This post explains the change in details.
At work, we are using direnv for quickly managing environment variables on our repository. When we cd into a directory, or a subtree, it automatically detects the file .envrc in the current directory (or the nearest parent directory), loads environment variables, and execute predefined commands."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/sapling.direnv/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2022-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-20T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="Make sapling work with direnv"><meta name="twitter:description" content="In the last post, I shared my experience with Sapling, Meta’s new Git client. It requires some workaround with direnv. This post explains the change in details.
At work, we are using direnv for quickly managing environment variables on our repository. When we cd into a directory, or a subtree, it automatically detects the file .envrc in the current directory (or the nearest parent directory), loads environment variables, and execute predefined commands."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/sapling.direnv/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Make sapling work with direnv</h1><div class="meta"><div class="postdate"><time datetime="2022-12-20 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-12-20</time></div><div class="article-tag">&nbsp;· <a class="tag-link" href="/w/#git" rel="tag">git</a></div></div></header><div class="content" itemprop="articleBody"><p><em>In the <a href="../sapling">last post</a>, I shared my experience with Sapling, Meta’s new Git client. It requires some workaround with direnv. This post explains the change in details.</em></p><p>At work, we are using <a href="https://direnv.net">direnv</a> for quickly managing environment variables on our repository. When we <code>cd</code> into a directory, or a subtree, it automatically detects the file <code>.envrc</code> in the current directory (or the nearest parent directory), loads environment variables, and execute predefined commands.</p><h2 id="our-typical-envrc">Our typical .envrc:</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-toplevel<span class="k">)</span>
<span class="nb">export</span> <span class="nv">REL_PATH_FROM_PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-prefix<span class="k">)</span>

PATH_add <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
</code></pre></div><p>With this file, when we <code>cd</code> to a subtree, it will:</p><ul><li>Set <code>PROJECT_ROOT</code> to the root of the git repository, of course, our monorepo.</li><li>Set <code>REL_PATH_FROM_PROJECT_ROOT</code> to the relative path from the root of the git repository.</li><li>Add the current directory to <code>PATH</code>. It allows executing commands in the current directory by typing <code>command</code> instead of <code>./command</code>. We usually define a <code>run</code> command, to define some common commands for the current directory.</li></ul><p>It works well. Until one day, I want to use <a href="../sapling">sapling</a>!</p><h2 id="make-sapling-work-with-direnv">Make sapling work with direnv</h2><p>The above <code>.envrc</code> uses <code>git rev-parse --show-top-level</code> to get the root of the git repository. Sapling is a new Git client, it works with Git repositories, but it&rsquo;s not Git. It doesn&rsquo;t have <code>git rev-parse</code> command. So, we need to find a way to make it work with direnv.</p><p>Hence, I come up with this function:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sl_project_root<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local</span> <span class="nv">pdir</span><span class="o">=</span>./<span class="p">;</span>        <span class="c1"># project directory</span>
  <span class="k">while</span> <span class="o">[[</span> <span class="si">${#</span><span class="nv">pdir</span><span class="si">}</span> -lt <span class="m">30</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> ! ls <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pdir</span><span class="si">}</span><span class="s2">.sl&#34;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">do</span>
    <span class="nv">pdir</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">pdir</span><span class="si">}</span><span class="s2">../&#34;</span>
  <span class="k">done</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="si">${#</span><span class="nv">pdir</span><span class="si">}</span> -lt <span class="m">30</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># shellcheck disable=SC2155</span>
    <span class="nb">export</span> <span class="nv">PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>realpath <span class="s2">&#34;</span><span class="si">${</span><span class="nv">pdir</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span> <span class="p">;</span>
    <span class="c1"># shellcheck disable=SC2155</span>
    <span class="nb">export</span> <span class="nv">REL_PATH_FROM_PROJECT_ROOT</span><span class="o">=</span><span class="se">\
</span><span class="se"></span>      <span class="k">$(</span>python -c <span class="s2">&#34;import os; print(os.path.relpath(\&#34;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">\&#34;,\&#34;</span><span class="si">${</span><span class="nv">pdir</span><span class="si">}</span><span class="s2">\&#34;))&#34;</span><span class="k">)</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PROJECT_ROOT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  sl_project_root
<span class="k">fi</span>
</code></pre></div><p>The first part is to find the nearest <code>.sl</code> directory, which is where sapling stores its local data. When found, the <code>PROJECT_ROOT</code> will be set to the parent directory of <code>.sl</code>.</p><p>The second part empowers Python to calculate the relative path from the root of the git repository, with <code>os.path.relpath()</code>. Python is pre-installed on Mac and most Linux distributions, so it&rsquo;s a good choice.</p><h2 id="put-all-things-together">Put all things together</h2><p>Another problem is that the above snippet is a bit long. And we have many <code>.envrc</code> files around the monorepo. When the <code>.envrc</code> file is changed, we need to update all of them. Other people is asked to run <code>direnv allow</code> again in every directory with <code>.envrc</code>. It&rsquo;s the policy of direnv to make sure that the user is aware of the change. And what if we want to make change to the snippet in the future? We need to update all of them and make other people annoyed again.</p><p>Let&rsquo;s fix it. So we&rsquo;ll create a new file called <code>.project_root.sh</code> with the above snippet. And people who want to use sapling just need to add the <em>soft-link</em> of the file to their <code>$PATH</code>. Something like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># assume that ~/bin is included in $PATH</span>
ln -s /path/to/repo/.project_root.sh ~/bin/.project_root.sh
</code></pre></div><p>Finally, we can update the <code>.envrc</code> file to:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-toplevel 2&gt;/dev/null<span class="k">)</span>
<span class="nb">export</span> <span class="nv">REL_PATH_FROM_PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-prefix 2&gt;/dev/null<span class="k">)</span>
git rev-parse 2&gt;/dev/null <span class="o">||</span> <span class="nb">source</span> .project_root.sh

PATH_add <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
</code></pre></div><p>The next time <code>.project_root.sh</code> get updated, people don&rsquo;t need to do anything as it will be automatically loaded. And only people with sapling will be affected. Other people don&rsquo;t need to add the soft-link. Of course, it&rsquo;s required that we trust the <code>.project_root.sh</code> file. But it&rsquo;s our repository anyway.</p><p><em>Read more: <a href="../sapling">My first impressions of Sapling — Meta’s new Git client</a></em></p><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://twitter.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#our-typical-envrc">Our typical .envrc:</a></li>\n    <li><a href="#make-sapling-work-with-direnv">Make sapling work with direnv</a></li>\n    <li><a href="#put-all-things-together">Put all things together</a></li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Make sapling work with direnv</a></div><nav id="TableOfContents"><ul><li><a href="#our-typical-envrc">Our typical .envrc:</a></li><li><a href="#make-sapling-work-with-direnv">Make sapling work with direnv</a></li><li><a href="#put-all-things-together">Put all things together</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fsapling.direnv%2f&title=Make%20sapling%20work%20with%20direnv"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fsapling.direnv%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fsapling.direnv%2f&text=Make%20sapling%20work%20with%20direnv"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fsapling.direnv%2f&title=Make%20sapling%20work%20with%20direnv"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fsapling.direnv%2f&t=Make%20sapling%20work%20with%20direnv"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2023 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>