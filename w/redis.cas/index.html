<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Compare and swap in Redis | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Compare and swap in Redis"><meta property="og:description" content="Compare and swap Compare and swap is a familiar concept of atomic operation, for dealing with race condition. Suppose we want to build a lock for multiple instances to execute some command, and only one can be executed at a given time. An instance must wait for the lock to be released before it can take.
Instance 1: Current value is empty, set it to 1 and take the lock. Instance 2: Current value is not empty, wait."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/redis.cas/"><meta property="og:image" content="https://iOliverNguyen.github.io/w/redis.cas/_cover.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2022-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-29T00:00:00+00:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://iOliverNguyen.github.io/w/redis.cas/_cover.png"><meta name="twitter:title" content="Compare and swap in Redis"><meta name="twitter:description" content="Compare and swap Compare and swap is a familiar concept of atomic operation, for dealing with race condition. Suppose we want to build a lock for multiple instances to execute some command, and only one can be executed at a given time. An instance must wait for the lock to be released before it can take.
Instance 1: Current value is empty, set it to 1 and take the lock. Instance 2: Current value is not empty, wait."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/redis.cas/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Compare and swap in Redis</h1><div class="meta"><div class="postdate"><time datetime="2022-03-29 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-03-29</time></div><div class="article-tag">&nbsp;Â· <a class="tag-link" href="/w/#redis" rel="tag">redis</a></div></div></header><div class="content" itemprop="articleBody"><h2 id="compare-and-swap">Compare and swap</h2><p>Compare and swap is a familiar concept of atomic operation, for dealing with race condition. Suppose we want to build a lock for multiple instances to execute some command, and only one can be executed at a given time. An instance must wait for the lock to be released before it can take.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Instance 1: Current value is empty, set it to 1 and take the lock.
Instance 2: Current value is not empty, wait.
Instance 1: Done, set it to empty and release the lock.
Instance 2: Current value is empty, set it to 2 and take the lock.
</code></pre></div><p>In Go, this can be implemented by <a href="https://pkg.go.dev/sync/atomic#CompareAndSwapInt64">sync/atomic</a> package:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ok</span> <span class="o">:=</span> <span class="nf">CompareAndSwapInt64</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span><span class="p">)</span>

<span class="c1">// which is equivalent of the following code snippet, but atomic:
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">CompareAndSwapInt64</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">*</span><span class="nx">addr</span> <span class="o">==</span> <span class="nx">old</span> <span class="p">{</span>
        <span class="o">*</span><span class="nx">addr</span> <span class="p">=</span> <span class="nx">new</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div><p>And for locking between multiple instances, we&rsquo;ll need to use Redis. We can try doing that in a similar way. But keep in mind that this code snippet is not atomic:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">val</span> <span class="o">:=</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;GET mykey&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;SET mykey 1&#34;</span><span class="p">)</span>
    <span class="c1">// execute some command
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>When multiple instances execute the commands at the same time, they can both successfully acquire the lock! And we have race condition:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">Instance</span> <span class="mi">1</span><span class="p">:</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;GET mykey&#34;</span><span class="p">)</span>             <span class="c1">// empty
</span><span class="c1"></span><span class="nx">Instance</span> <span class="mi">2</span><span class="p">:</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;GET mykey&#34;</span><span class="p">)</span>             <span class="c1">// empty
</span><span class="c1"></span><span class="nx">Instance</span> <span class="mi">1</span><span class="p">:</span> <span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;SET mykey 1&#34;</span><span class="p">)</span> <span class="p">}</span>
<span class="nx">Instance</span> <span class="mi">2</span><span class="p">:</span> <span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;SET mykey 2&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// race condition!
</span></code></pre></div><p>To implement an optimistic locking in Redis, we need to use <code>WATCH</code>, <code>MULTI</code> and <code>EXEC</code> for a <a href="https://redis.io/docs/manual/transactions/">transaction</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nf">exec</span><span class="p">(</span><span class="s">&#34;WATCH mykey&#34;</span><span class="p">)</span>
<span class="nx">val</span> <span class="o">:=</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;GET mykey&#34;</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="s">&#34;MULTI&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;SET mykey 1&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">ok</span> <span class="o">:=</span> <span class="nf">exec</span><span class="p">(</span><span class="s">&#34;EXEC&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
    <span class="c1">// acquired the lock successfully, now execute some command
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>That is, when multiple clients try to set the key at the same between the execution of <code>WATCH</code> and <code>EXEC</code>, the transaction will be failed. And these clients can try acquiring the lock again.</p><h2 id="there-is-a-better-way">There is a better way!</h2><p>From <a href="https://redis.io/commands/set/">Redis 7.0</a>, there is support for compare and swap within a single command:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">SET</span> <span class="nx">mykey</span> <span class="mi">1</span> <span class="nx">NX</span> <span class="nx">GET</span>
</code></pre></div><p>The <code>SET</code> command can include <code>GET</code> to return the old value stored at <code>mykey</code>. And <code>NX</code> is there for setting the key only if it is empty.</p><p>That&rsquo;s it! No need for a transaction with <code>WATCH</code>. Just a single command and we can have lock between multiple instances ð¥³</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">How to implement Compare and swap in Redis, with SET NX GET<a href="https://x.com/hashtag/redis?src=hash&amp;ref_src=twsrc%5Etfw">#redis</a> <a href="https://t.co/8ICqaKEGid">https://t.co/8ICqaKEGid</a></p>&mdash; Oliver Nguyen (@_OliverNguyen) <a href="https://x.com/_OliverNguyen/status/1508636428036898818?ref_src=twsrc%5Etfw">March 29, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#compare-and-swap">Compare and swap</a></li>\n    <li><a href="#there-is-a-better-way">There is a better way!</a></li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Compare and swap in Redis</a></div><nav id="TableOfContents"><ul><li><a href="#compare-and-swap">Compare and swap</a></li><li><a href="#there-is-a-better-way">There is a better way!</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fredis.cas%2f&title=Compare%20and%20swap%20in%20Redis"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fredis.cas%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fredis.cas%2f&text=Compare%20and%20swap%20in%20Redis"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fredis.cas%2f&title=Compare%20and%20swap%20in%20Redis"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fredis.cas%2f&t=Compare%20and%20swap%20in%20Redis"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>