<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>µjson - A minimal JSON parser and transformer in Go | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="µjson - A minimal JSON parser and transformer in Go"><meta property="og:description" content="µjson is a minimal JSON parser and transformer that works on unstructured (and trusted) JSON. It works by parsing input and calling the given callback function when encountering each item.
Motivation Sometimes we just want to make some minimal changes to a JSON document or do some generic transformations without fully unmarshalling it. For example, removing blacklisted keys from response JSON. Why spend all the cost on unmarshalling into a map[string]interface{} just to immediately marshal it again."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/ujson/"><meta property="og:image" content="https://iOliverNguyen.github.io/w/ujson/_cover.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2021-01-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-09T00:00:00+00:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://iOliverNguyen.github.io/w/ujson/_cover.png"><meta name="twitter:title" content="µjson - A minimal JSON parser and transformer in Go"><meta name="twitter:description" content="µjson is a minimal JSON parser and transformer that works on unstructured (and trusted) JSON. It works by parsing input and calling the given callback function when encountering each item.
Motivation Sometimes we just want to make some minimal changes to a JSON document or do some generic transformations without fully unmarshalling it. For example, removing blacklisted keys from response JSON. Why spend all the cost on unmarshalling into a map[string]interface{} just to immediately marshal it again."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/ujson/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">µjson - A minimal JSON parser and transformer in Go</h1><div class="meta"><div class="postdate"><time datetime="2021-01-09 00:00:00 &#43;0000 UTC" itemprop="datePublished">2021-01-09</time></div><div class="article-tag">&nbsp;· <a class="tag-link" href="/w/#go" rel="tag">go</a></div><div class="published-at">published at <a target="_blank" href="https://hackernoon.com/json-a-minimal-json-parser-and-transformer-in-go-8eo34lp">Hacker Noon</a> , <a target="_blank" href="https://medium.com/swlh/%C2%B5json-a-minimal-json-parser-and-transformer-in-go-3798c4a46d3a">The Startup</a></div></div></header><div class="content" itemprop="articleBody"><p><a href="https://github.com/iOliverNguyen/ujson">µjson</a> is a minimal JSON parser and transformer that works on <em>unstructured (and trusted) JSON</em>. It works by parsing input and calling the given callback function when encountering each item.</p><h2 id="motivation">Motivation</h2><p>Sometimes we just want to make some minimal changes to a JSON document or do some generic transformations without fully unmarshalling it. For example, removing blacklisted keys from response JSON. Why spend all the cost on unmarshalling into a <code>map[string]interface{}</code> just to immediately marshal it again. The following code is taken from <a href="https://stackoverflow.com/questions/35441254/making-minimal-modification-to-json-data-without-a-structure-in-golang">StackOverflow</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;responseHeader&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;QTime&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;q&#34;</span><span class="p">:</span> <span class="s2">&#34;solo&#34;</span><span class="p">,</span>
      <span class="nt">&#34;wt&#34;</span><span class="p">:</span> <span class="s2">&#34;json&#34;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;response&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;numFound&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;docs&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>With <a href="https://github.com/iOliverNguyen/ujson">µjson</a>, we can quickly write <a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk--RemoveBlacklistFields2">a simple transformation</a> to remove <code>&quot;responseHeader&quot;</code> completely from all responses, once and forever. More on that later.</p><p>The original scenario that leads me to write the package is because of <em><strong>int64</strong></em>. When working in Go and PostgreSQL, I use <em><strong>int64</strong></em> (instead of <em><strong>string</strong></em>) for <em><strong>ids</strong></em> because it’s more effective and has enormous space for randomly generated ids. It’s not as big as UUID, 128 bits, but still big enough for production use. In PostgreSQL, those ids can be stored as bigint and being effectively indexed. But for JavaScript, it can only process integer up to 53 bits (JavaScript has BigInt but that’s a different story, and using it will make things even more complicated).</p><p>So we need to wrap those int64s into strings before sending them to JavaScript. In Go and PostgreSQL, the JSON is <code>{&quot;order_id&quot;: 12345678}</code> but JavaScript will see it as <code>{&quot;order_id&quot;: &quot;12345678&quot;}</code> (note that the value is quoted). In Go, we can define a custom type and implement the <a href="https://golang.org/pkg/encoding/json/#Marshaler">json.Marshaler</a> interface. But in PostgreSQL, that’s just not possible or too complicated. I wrote a service that receives JSON from PostgreSQL and converts it to be consumable by JavaScript. The service also removes some blacklisted keys or does some other transformations (for example, change <code>orderId</code> to <code>order_id</code>).</p><p>So I wrote a simple JSON parser and transformer. It can:</p><ul><li><a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk">Print all keys and values in order</a></li><li><a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk--Reformat">Reformat input</a></li><li><a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk--Reconstruct">Remove all whitespaces</a></li><li><a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk--RemoveBlacklistFields2">Remove blacklisted keys</a></li><li><a href="https://godoc.org/github.com/iOliverNguyen/ujson#example-Walk--WrapInt64InString">Wrap int64s into strings before handing to JavaScript</a></li><li>Extract some values</li><li>… and more.</li></ul><p><em><strong>Important:</strong></em> <em>Behavior is undefined for invalid JSON, use on trusted input only! For untrusted input, you might want to run it through <a href="https://golang.org/pkg/encoding/json/#Valid">json.Valid()</a> before handing it to <a href="https://github.com/iOliverNguyen/ujson">µjson</a>.</em></p><h2 id="lets-see-how-µjson-work-by-examples">Let’s see how µjson work by examples:</h2><h3 id="1-print-all-keys-and-values-in-order">1. Print all keys and values in order</h3><p>The callback function is called when an object key/value or an array key is encountered. It receives 3 params in order: <code>level</code>, <code>key</code> and <code>value</code>.</p><ul><li><code>level</code> is the indentation level of the JSON, if you format it properly. It starts from 0. It increases after entering an object or array and decreases after leaving.</li><li><code>key</code> is the raw key of the current object or empty otherwise. It can be a double-quoted string or empty.</li><li><code>value</code> is the raw value of the current item or a bracket. It can be a string, number, boolean, null, or one of the following brackets: <code>{ } [ ]</code>. Values will never be empty.</li></ul><p>It’s important to note that key and value are provided as raw. Strings are always double-quoted. It’s there for keeping the library fast and ignoring unnecessary operations. For example, when you only want to reformat the output JSON properly; you don’t want to unquote those strings and then immediately quote them again; you just need to output them unmodified. And there are <a href="https://godoc.org/github.com/iOliverNguyen/ujson#Unquote">ujson.Unquote()</a> and <a href="https://godoc.org/github.com/iOliverNguyen/ujson#AppendQuote">ujson.AppendQuote()</a> when you need to get the original strings.</p><p>When processing arrays and objects, first the open bracket (<code>[</code>, <code>{</code>) will be provided as value, followed by its children, and the close bracket (<code>]</code>, <code>}</code>). When encountering open brackets, you can make the callback function return <code>false</code> to skip the object/array entirely.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>	

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>	
<span class="kn">import</span> <span class="s">&#34;github.com/iOliverNguyen/ujson&#34;</span>	

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>	
	<span class="nx">input</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{	
</span><span class="s">		&#34;id&#34;: 12345,	
</span><span class="s">		&#34;name&#34;: &#34;foo&#34;,	
</span><span class="s">		&#34;numbers&#34;: [&#34;one&#34;, &#34;two&#34;],	
</span><span class="s">		&#34;tags&#34;: {&#34;color&#34;: &#34;red&#34;, &#34;priority&#34;: &#34;high&#34;},	
</span><span class="s">		&#34;active&#34;: true	
</span><span class="s">	}`</span><span class="p">)</span>	
	<span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>	
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%2v% 12s : %s\n&#34;</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>	
		<span class="k">return</span> <span class="kc">true</span>	
	<span class="p">})</span>	
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"> 0             : {
 1        &#34;id&#34; : 12345
 1      &#34;name&#34; : &#34;foo&#34;
 1   &#34;numbers&#34; : [
 2             : &#34;one&#34;
 2             : &#34;two&#34;
 1             : ]
 1      &#34;tags&#34; : {
 2     &#34;color&#34; : &#34;red&#34;
 2  &#34;priority&#34; : &#34;high&#34;
 1             : }
 1    &#34;active&#34; : true
 0             : }
</code></pre></div><h3 id="0-the-simplest-examples">0. The simplest examples</h3><p>To easily get an idea on <code>level</code>, <code>key</code> and <code>value</code>, here are the simplest examples:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
<span class="kn">import</span> <span class="s">&#34;github.com/iOliverNguyen/ujson&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">input0</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`true`</span><span class="p">)</span>
	<span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input0</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;level=%v key=%s value=%s\n&#34;</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="c1">// output:
</span><span class="c1"></span>	<span class="c1">//   level=0 key= value=true
</span><span class="c1"></span>
	<span class="nx">input1</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;key&#34;: 42 }`</span><span class="p">)</span>
	<span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input1</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;level=%v key=%s value=%s\n&#34;</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="c1">// output:
</span><span class="c1"></span>	<span class="c1">//   level=0 key= value={
</span><span class="c1"></span>	<span class="c1">//   level=1 key=&#34;key&#34; value=42
</span><span class="c1"></span>	<span class="c1">//   level=0 key= value=}
</span><span class="c1"></span>
	<span class="nx">input2</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`[ true ]`</span><span class="p">)</span>
	<span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input2</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;level=%v key=%s value=%s\n&#34;</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="c1">// output:
</span><span class="c1"></span>	<span class="c1">//   level=0 key= value=[
</span><span class="c1"></span>	<span class="c1">//   level=1 key= value=true
</span><span class="c1"></span>	<span class="c1">//   level=0 key= value=]
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>In the first example, there is only a single boolean value. The callback function is called once with <code>level=0</code>, <code>key</code> is empty and <code>value=true</code>.</p><p>In the second example, the callback function is called 3 times. Two times for open and close brackets with <code>level=0</code>, key is empty and value is the bracketed character. The other time for the only key with <code>level=1</code>, <code>key</code> is <code>&quot;key&quot;</code> and <code>value=42</code>. Note that the key is quoted and you need to call <a href="https://godoc.org/github.com/iOliverNguyen/ujson#Unquote">ujson.Unquote()</a> to retrieve the unquoted string.</p><p>The last example is like the second, but with an array instead. Keys are always empty inside arrays.</p><h3 id="2-reformat-input">2. Reformat input</h3><p>In this example, the input JSON is formatted with correct indentation. As processing the input key by key, the callback function reconstructs the JSON. It outputs each key/value pair in its own line, prefixed with spaces equal to the param level. There is a catch, though. Valid JSON requires commas between values in objects and arrays. So there is <a href="https://godoc.org/github.com/iOliverNguyen/ujson#ShouldAddComma">ujson.ShouldAddComma()</a> for checking whether a comma should be inserted.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
<span class="kn">import</span> <span class="s">&#34;github.com/iOliverNguyen/ujson&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;id&#34;:12345,&#34;name&#34;:&#34;foo&#34;,&#34;numbers&#34;:[&#34;one&#34;,&#34;two&#34;],&#34;tags&#34;:{&#34;color&#34;:&#34;red&#34;,&#34;priority&#34;:&#34;high&#34;},&#34;active&#34;:true}`</span><span class="p">)</span>

	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">ShouldAddComma</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">level</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="o">...</span><span class="p">)</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="s">`: `</span><span class="o">...</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">value</span><span class="o">...</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s\n&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
	<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
	<span class="nt">&#34;numbers&#34;</span><span class="p">:</span> <span class="p">[</span>
		<span class="s2">&#34;one&#34;</span><span class="p">,</span>
		<span class="s2">&#34;two&#34;</span>
	<span class="p">],</span>
	<span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;red&#34;</span><span class="p">,</span>
		<span class="nt">&#34;priority&#34;</span><span class="p">:</span> <span class="s2">&#34;high&#34;</span>
	<span class="p">},</span>
	<span class="nt">&#34;active&#34;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div><p>There is a built-in method <a href="https://godoc.org/github.com/iOliverNguyen/ujson#Reconstruct">ujson.Reconstruct()</a> when you want to remove all the whitespaces.</p><h3 id="3-remove-blacklisted-keys">3. Remove blacklisted keys</h3><p>This example demonstrates removing some keys from the input JSON. The key param is compared with a pre-defined list. If there is a match, the blacklisted key and its value are dropped. The callback function returns false for skipping the entire value (which may be an object or array). Note that the list is quoted, i.e. <code>&quot;numbers&quot;</code> and <code>&quot;active&quot;</code> instead of <code>number</code> and <code>active</code>. For more advanced checking, you may want to run <a href="https://godoc.org/github.com/iOliverNguyen/ujson#Unquote">ujson.Unquote()</a> on the key.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;bytes&#34;</span>
<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
<span class="kn">import</span> <span class="s">&#34;github.com/iOliverNguyen/ujson&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{
</span><span class="s">		&#34;id&#34;: 12345,
</span><span class="s">		&#34;name&#34;: &#34;foo&#34;,
</span><span class="s">		&#34;numbers&#34;: [&#34;one&#34;, &#34;two&#34;],
</span><span class="s">		&#34;tags&#34;: {&#34;color&#34;: &#34;red&#34;, &#34;priority&#34;: &#34;high&#34;},
</span><span class="s">		&#34;active&#34;: true
</span><span class="s">	}`</span><span class="p">)</span>

	<span class="nx">blacklistFields</span> <span class="o">:=</span> <span class="p">[][]</span><span class="kt">byte</span><span class="p">{</span>
		<span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;numbers&#34;`</span><span class="p">),</span> <span class="c1">// note the quotes
</span><span class="c1"></span>		<span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;active&#34;`</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">blacklist</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">blacklistFields</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">blacklist</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">// remove the key and value from the output
</span><span class="c1"></span>				<span class="k">return</span> <span class="kc">false</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="c1">// write to output
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">ShouldAddComma</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="o">...</span><span class="p">)</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">value</span><span class="o">...</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s\n&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;id&#34;</span><span class="p">:</span><span class="mi">12345</span><span class="p">,</span><span class="nt">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span><span class="nt">&#34;tags&#34;</span><span class="p">:{</span><span class="nt">&#34;color&#34;</span><span class="p">:</span><span class="s2">&#34;red&#34;</span><span class="p">,</span><span class="nt">&#34;priority&#34;</span><span class="p">:</span><span class="s2">&#34;high&#34;</span><span class="p">}}</span>
</code></pre></div><p>As you see in the output, <code>&quot;numbers&quot;</code> and <code>&quot;active&quot;</code> are removed.</p><h3 id="4-wrap-int64-in-string">4. Wrap int64 in string</h3><p>This is the original motivation behind <a href="https://github.com/iOliverNguyen/ujson">µjson</a>. The following example finds keys ending with <code>_id&quot;</code> (<code>&quot;order_id&quot;</code>, <code>&quot;item_id&quot;</code>, etc.) and converts their values from numbers to strings, by simply wrapping them in double-quotes.</p><p>For valid JSON, values are never empty. We can test the first byte of <code>value</code> (<code>value[0]</code>) to get its type:</p><ul><li><code>n</code> : Null</li><li><code>f</code> , <code>t</code> : Boolean</li><li><code>0</code>&hellip;<code>9</code> : Number</li><li><code>&quot;</code> : String, see <a href="https://godoc.org/github.com/iOliverNguyen/ujson#Unquote">ujson.Unquote()</a></li><li><code>[</code> , <code>]</code> : Array</li><li><code>{</code> , <code>}</code> : Object</li></ul><p>In this case, we check <code>value[0]</code> within <code>0</code>…<code>9</code> to see whether it’s a number, then insert double-quotes.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;bytes&#34;</span>
<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
<span class="kn">import</span> <span class="s">&#34;github.com/iOliverNguyen/ujson&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;order_id&#34;: 12345678901234, &#34;number&#34;: 12, &#34;item_id&#34;: 12345678905678, &#34;counting&#34;: [1,&#34;2&#34;,3]}`</span><span class="p">)</span>

	<span class="nx">suffix</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`_id&#34;`</span><span class="p">)</span> <span class="c1">// note the ending quote &#34;
</span><span class="c1"></span>	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">Walk</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="c1">// Test for keys with suffix _id&#34; and value is an int64 number. For valid json,
</span><span class="c1"></span>		<span class="c1">// values will never be empty, so we can safely test only the first byte.
</span><span class="c1"></span>		<span class="nx">shouldWrap</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">suffix</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">&gt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span>

		<span class="c1">// transform the input, wrap values in double quotes
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">ujson</span><span class="p">.</span><span class="nf">ShouldAddComma</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="o">...</span><span class="p">)</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">shouldWrap</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">value</span><span class="o">...</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">shouldWrap</span> <span class="p">{</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s\n&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;order_id&#34;</span><span class="p">:</span><span class="s2">&#34;12345678901234&#34;</span><span class="p">,</span><span class="nt">&#34;number&#34;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="nt">&#34;item_id&#34;</span><span class="p">:</span><span class="s2">&#34;12345678905678&#34;</span><span class="p">,</span><span class="nt">&#34;counting&#34;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">]}</span>
</code></pre></div><p>After processing, the numbers in <code>&quot;order_id&quot;</code> and <code>&quot;item_id&quot;</code> are quoted as strings. And JavaScript should be happy now! 🎉 🎉</p><h2 id="recap">Recap</h2><p>You can start using it by <a href="https://github.com/iOliverNguyen/ujson"><code>import &quot;github.com/iOliverNguyen/ujson&quot;</code></a>. The <a href="https://github.com/iOliverNguyen/ujson/blob/master/%C2%B5json.go">source code</a> is short and easy to read. Feedback is welcome 👋</p><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#motivation">Motivation</a></li>\n    <li><a href="#lets-see-how-µjson-work-by-examples">Let’s see how µjson work by examples:</a>\n      <ul>\n        <li><a href="#1-print-all-keys-and-values-in-order">1. Print all keys and values in order</a></li>\n        <li><a href="#0-the-simplest-examples">0. The simplest examples</a></li>\n        <li><a href="#2-reformat-input">2. Reformat input</a></li>\n        <li><a href="#3-remove-blacklisted-keys">3. Remove blacklisted keys</a></li>\n        <li><a href="#4-wrap-int64-in-string">4. Wrap int64 in string</a></li>\n      </ul>\n    </li>\n    <li><a href="#recap">Recap</a></li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">µjson - A minimal JSON parser and transformer in Go</a></div><nav id="TableOfContents"><ul><li><a href="#motivation">Motivation</a></li><li><a href="#lets-see-how-µjson-work-by-examples">Let’s see how µjson work by examples:</a><ul><li><a href="#1-print-all-keys-and-values-in-order">1. Print all keys and values in order</a></li><li><a href="#0-the-simplest-examples">0. The simplest examples</a></li><li><a href="#2-reformat-input">2. Reformat input</a></li><li><a href="#3-remove-blacklisted-keys">3. Remove blacklisted keys</a></li><li><a href="#4-wrap-int64-in-string">4. Wrap int64 in string</a></li></ul></li><li><a href="#recap">Recap</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fujson%2f&title=%c2%b5json%20-%20A%20minimal%20JSON%20parser%20and%20transformer%20in%20Go"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fujson%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fujson%2f&text=%c2%b5json%20-%20A%20minimal%20JSON%20parser%20and%20transformer%20in%20Go"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fujson%2f&title=%c2%b5json%20-%20A%20minimal%20JSON%20parser%20and%20transformer%20in%20Go"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fujson%2f&t=%c2%b5json%20-%20A%20minimal%20JSON%20parser%20and%20transformer%20in%20Go"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>