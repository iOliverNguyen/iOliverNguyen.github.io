<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Working with Stacked PRs using git-branchless, git-autofixup, and git-pr | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Working with Stacked PRs using git-branchless, git-autofixup, and git-pr"><meta property="og:description" content="I usually work with stacked PRs. It is a great way to organize my work and keep my commits small. This empowers separation of concern and limit scope of each PR. Reviewers can go through each PR and review them one by one. Smaller changes, better feedback!
 I was using sapling. It worked really well in the first month, but the honeymoon ended too soon. Read more... Using sapling, I can view stacked commits with sl smart logs, edit many files and make changes to many commits at the same time with sl absorb, have the stack automatically rebase after each change, and push these commits as multiple stacked GitHub PRs with a single sl pr command."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/stacked.prs/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2023-02-19T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-19T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="Working with Stacked PRs using git-branchless, git-autofixup, and git-pr"><meta name="twitter:description" content="I usually work with stacked PRs. It is a great way to organize my work and keep my commits small. This empowers separation of concern and limit scope of each PR. Reviewers can go through each PR and review them one by one. Smaller changes, better feedback!
 I was using sapling. It worked really well in the first month, but the honeymoon ended too soon. Read more... Using sapling, I can view stacked commits with sl smart logs, edit many files and make changes to many commits at the same time with sl absorb, have the stack automatically rebase after each change, and push these commits as multiple stacked GitHub PRs with a single sl pr command."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/stacked.prs/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Working with Stacked PRs using git-branchless, git-autofixup, and git-pr</h1><div class="meta"><div class="postdate"><time datetime="2023-02-19 00:00:00 &#43;0000 UTC" itemprop="datePublished">2023-02-19</time></div><div class="article-tag">&nbsp;· <a class="tag-link" href="/w/#git" rel="tag">git</a></div></div></header><div class="content" itemprop="articleBody"><p><em>I usually work with stacked PRs. It is a great way to organize my work and keep my commits small. This empowers separation of concern and limit scope of each PR. Reviewers can go through each PR and review them one by one. Smaller changes, better feedback!</em></p><details><summary><i>I was using <a href="https://sapling-scm.com">sapling</a>. It worked really well in the first month, but the honeymoon ended too soon. <a class="more">Read more...</a></i></summary><p>Using <a href="https://sapling-scm.com/">sapling</a>, I can view stacked commits with <code>sl</code> smart logs, edit many files and make changes to many commits at the same time with <code>sl absorb</code>, have the stack automatically rebase after each change, and push these commits as multiple stacked GitHub PRs with a single <code>sl pr</code> command. It&rsquo;s great! In the first month, I was very happy with sapling. You can read more about it in <a href="https://olivernguyen.io/w/sapling/">my last article</a>.</p><p>But the honeymoon ended when I wanted to push a stack with 17 commits to GitHub. I reached GitHub&rsquo;s rate limit after creating 10 PRs and got a temporary ban:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ sl pr 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> go run ~/ws/conn/be/go/scripts/slpr
pushing <span class="m">17</span> to https://github.com/myorganization/backend.git
created new pull request: https://github.com/myorganization/backend/pull/3310
...
created new pull request: https://github.com/myorganization/backend/pull/3319
abort: error creating pull request <span class="k">for</span> f05689dca505b3ad1b526a220d7a15f46b4a9511: <span class="o">{</span>
 <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;You have exceeded a secondary rate limit and have been temporarily blocked from content creation. Please retry your request again later.&#34;</span>,
 <span class="s2">&#34;documentation_url&#34;</span>: <span class="s2">&#34;https://docs.github.com/rest/overview/resources-in-the-rest-api#secondary-rate-limits&#34;</span>
<span class="o">}</span>
</code></pre></div><p>This left my sapling repository in a bad state. The local commits and the GitHub PRs no longer match. Even after the ban lift, I could not push the remaining commits to GitHub anymore:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ sl pr
pushing <span class="m">8</span> to https://github.com/myorganization/backend.git
abort: <span class="sb">`</span>git --git-dir /Users/i/ws/conn/be/.sl/store/git push --force https://github.com/myorganization/backend.git 447c5d073cbadd4bcc251bf8bcd46d9ec4f728bd:refs/heads/pr3320 3f0d1e3103e5246e29806f44b87f4e9289749202:refs/heads/pr3320 7403ecce2590066177a23923bbd509598fe32781:refs/heads/pr3321 8750722250395b8d7e5a2e624a5c65a42ee817e0:refs/heads/pr3322 b543123ebadcca0b1de95293fd551752e1fa0c43:refs/heads/pr3323 263fde607355872bb47305168bf1907d673b0249:refs/heads/pr3324 5b590681dbe1394b7cae9a7d1e9f823205da3cc7:refs/heads/pr3325 17137b286aa5376615a77e58f3ef71bf02a3398f:refs/heads/pr3326<span class="sb">`</span> failed with <span class="nb">exit</span> code 1: stdout:
stderr: error: dst ref refs/heads/pr3320 receives from more than one src
error: failed to push some refs to <span class="s1">&#39;https://github.com/myorganization/backend.git&#39;</span>
</code></pre></div><p>The problem is that I do not know the internals of sapling enough to be able to fix it. I had to switch back to git and manually pushed the remaining commits to GitHub.</p></details><p><em>So I decided to bring the sapling&rsquo;s workflow to git with <a href="https://github.com/arxanas/git-branchless">git-branchless</a>, <a href="https://github.com/torbiak/git-autofixup">git-autofixup</a>, and writing my own command, <a href="https://github.com/iOliverNguyen/git-pr">git-pr</a>. Together, they work really well with my stacked PRs workflow. And I can use my Git knowledge to fix problems.</em></p><p>To see the workflow with stacked PRs in <a href="https://github.com/arxanas/git-branchless">git-branchless</a>/<a href="https://github.com/torbiak/git-autofixup">git-autofixup</a>/<a href="https://github.com/iOliverNguyen/git-pr">git-pr</a>, let&rsquo;s take an example from developing the <em>user sign-up feature</em>: user inputs their email address, password, and we send them a nice welcome email. From the backend perspective, we need to <em>(1) create a new user</em>, <em>(2) verify that the user doesn&rsquo;t exist</em>, and <em>(3) send the email</em>. We need to touch the implementation of the <em>cache</em> package, add an <em>email</em> package, then finally implement the sign-up logic. This can be represented as a stack of PRs:</p><ol><li>Update the <em>cache</em> package to add a new method.</li><li>Add the <em>email</em> package. It uses the <em>cache</em> package to prevent sending duplicated emails.</li><li>Implement the sign-up logic. It depends on the two changes above.</li></ol><p><img src="../sapling/stacked.png" alt=""></p><br><details><summary><i>Click to see the previous workflow with sapling</i></summary><h2>The stacked PRs workflow with sapling</h2>Here are my most use commands while working with sapling:<p><strong>1. View the stacked commits and PRs</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ sl
o bf31e38d1 Today at 04:14 remote/main
│
│ @  00f1749f6  <span class="m">30</span> minutes ago  oliver
│ │  implement user signup
│ │
│ o  e0dbbc80e  <span class="m">50</span> minutes ago  oliver
│ │  implement email package
│ │
│ o  4f6928029  Yesterday at   oliver
├─╯  update cache package
│
</code></pre></div><p>We have a stack with 3 commits.</p><p><strong>2. Edit a commit message with <code>sl metaedit</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sl metaedit 4f6928029
</code></pre></div><p>Update the commit message for the cache commit. And automatically rebase all the commits above.</p><p><strong>3. Make changes to multiple commits with <code>sl absorb</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sl goto 00f1749f6              <span class="c1"># checkout the sign up code</span>
vim features/signup/signup.go  <span class="c1"># make changes to signup package</span>
vim lib/email/email.go         <span class="c1"># make changes to email package</span>
        
sl absorb                      <span class="c1"># magic 👻</span>
</code></pre></div><p>With a single command <code>sl absorb</code>, the <code>signup.go</code> changes will be amended to the signup commit, the <code>email.go</code> changes will be amended to the email commit, and the commits will be automatically rebase onto each other.</p><p><strong>4. Rebase a stack of commits with <code>sl rebase -s</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sl rebase -s 4f6928029 -d remote/main
</code></pre></div><p>The stack will be rebased onto remote/main.</p><p><strong>4. Undo mistakes with <code>sl undo</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sl undo
</code></pre></div><p><strong>5. Push all commits and create stacked PRs with <code>sl pr</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ sl pr
pushing <span class="m">3</span> to https://github.com/myorganization/backend.git
created new pull request: https://github.com/myorganization/backend/pull/2810
created new pull request: https://github.com/myorganization/backend/pull/2811
created new pull request: https://github.com/myorganization/backend/pull/2812
</code></pre></div><p>Push all the commits the remote repository and associate one PR for each commit.</p></details><h2 id="the-stacked-prs-workflow-with-git">The stacked PRs workflow with git</h2><p>Now let&rsquo;s see how we work with stacked PRs in git. First, we need to install a few things: <a href="https://cli.github.com/">github-cli</a>, <a href="https://github.com/arxanas/git-branchless">git-branchless</a>, <a href="https://github.com/torbiak/git-autofixup">git-autofixup</a>, and <a href="https://github.com/iOliverNguyen/git-pr">git-pr</a>.</p><ul><li>Install <a href="https://github.com/cli/cli#installation">github-cli</a> then run <code>gh auth login</code>.</li><li>Install <a href="https://github.com/arxanas/git-branchless#installation">git-branchless</a> then run <code>git branchless init</code> in your repository.</li><li>Install <a href="https://github.com/torbiak/git-autofixup/releases">git-autofixup</a> by downloading <a href="https://github.com/torbiak/git-autofixup/releases">the script</a> and put it in your <code>$PATH</code>.</li><li>Install <a href="https://github.com/iOliverNguyen/git-pr">git-pr</a> and put it in your <code>$PATH</code>:<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/iOliverNguyen/git-pr
<span class="nb">cd</span> git-pr
go install .
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:~/bin/go  <span class="c1"># put git-pr in your $PATH</span>

<span class="c1"># don&#39;t forget to login with gh cli</span>
gh auth login
</code></pre></div></li></ul><h3 id="initialize-git-branchless">Initialize git-branchless</h3><p>After install git-branchless, we need to go to the repository directory and run the init command:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">cd</span> my-project
$ git branchless init 
Created config file at /Users/i/my-project/.git/branchless/config
Auto-detected your main branch as: main
</code></pre></div><p>This will generate a config file with the following content. It indicates that git-branchless has added a bunch of alias to your repository.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cat /Users/i/my-project/.git/branchless/config
<span class="o">[</span>branchless <span class="s2">&#34;core&#34;</span><span class="o">]</span>
	<span class="nv">mainBranch</span> <span class="o">=</span> main
<span class="o">[</span>advice<span class="o">]</span>
	<span class="nv">detachedHead</span> <span class="o">=</span> <span class="nb">false</span>
<span class="o">[</span>log<span class="o">]</span>
	<span class="nv">excludeDecoration</span> <span class="o">=</span> refs/branchless/*
<span class="o">[</span>alias<span class="o">]</span>
	<span class="nv">amend</span> <span class="o">=</span> branchless amend
	<span class="nv">hide</span> <span class="o">=</span> branchless hide
	<span class="nv">move</span> <span class="o">=</span> branchless move
	<span class="nv">next</span> <span class="o">=</span> branchless next
	<span class="nv">prev</span> <span class="o">=</span> branchless prev
	<span class="nv">query</span> <span class="o">=</span> branchless query
	<span class="nv">record</span> <span class="o">=</span> branchless record
	<span class="nv">restack</span> <span class="o">=</span> branchless restack
	<span class="nv">reword</span> <span class="o">=</span> branchless reword
	<span class="nv">sl</span> <span class="o">=</span> branchless smartlog
	<span class="nv">smartlog</span> <span class="o">=</span> branchless smartlog
	<span class="nv">submit</span> <span class="o">=</span> branchless submit
	<span class="nv">sw</span> <span class="o">=</span> branchless switch
	<span class="nv">sync</span> <span class="o">=</span> branchless sync
	<span class="nb">test</span> <span class="o">=</span> branchless <span class="nb">test</span>
	<span class="nv">undo</span> <span class="o">=</span> branchless undo
	<span class="nv">unhide</span> <span class="o">=</span> branchless unhide
</code></pre></div><h3 id="view-stacked-commits-with-git-sl-git-branchless">View stacked commits with &ldquo;git sl&rdquo; (git-branchless)</h3><p>After running <code>git branchless init</code> in your repository, you will have access to a few useful commands to manage stacked commits.<br>Let&rsquo;s start with <code>git sl</code> to view the stack (<code>sl</code> stands for &ldquo;smart logs&rdquo;):</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl                      <span class="c1"># alias: gg</span>
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ 4f69280 1d update cache package
┃
◯ e0dbbc8 50m implement email package
┃
● 00f1749 30m implement user signup
</code></pre></div><p>Checkout a commit using <code>git checkout</code> (alias <code>gco</code>). Moving between commits in a stack using <code>git next</code> and <code>git prev</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git checkout bf31e38        <span class="c1"># alias: gco</span>
$ git next                    <span class="c1"># checkout at 4f69280</span>
$ git next <span class="m">2</span>                  <span class="c1"># checkout at 00f1749</span>
$ git prev <span class="m">1</span>                  <span class="c1"># checkout at e0dbbc8</span>
</code></pre></div><p>You can use aliases to make it shorter. My most frequently used alias is <span class="nowrap"><code>gg</code> for <code>git sl</code></span>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gg                  <span class="c1"># git sl</span>
$ gco 4f69280         <span class="c1"># git checkout 4f69280</span>
</code></pre></div><h3 id="delete-your-local-branches-and-hide-unused-commit-with-span-classnowrapgit-hidespan-span-classnowrapgit-branchlessspan">Delete your local branches and hide unused commit with <span class="nowrap">&ldquo;git hide&rdquo;</span> <span class="nowrap">(git-branchless)</span></h3><p>Notice that we no longer need to use git branches. From now on, we&rsquo;ll use commit hash instead. Let&rsquo;s delete all local branches and hide all unused commits:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git branch -D branch1 branch2       <span class="c1"># delete all local branches</span>
$ git hide d7edab6 6b865dd            <span class="c1"># hide all unused commits</span>
Hid commit: d7edab6 a draft change
Hid commit: 6b865dd temporary commit
To unhide these <span class="m">2</span> commits, run: git undo
</code></pre></div><h3 id="undo-mistake-with-git-undo-span-classnowrapgit-branchlessspan">undo mistake with &ldquo;git undo&rdquo; <span class="nowrap">(git-branchless)</span></h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git undo
Will apply these actions:
1. Unhide commit d7edab6 a draft change

2. Unhide commit 6b865dd temporary commit

Confirm? <span class="o">[</span>yN<span class="o">]</span> y
</code></pre></div><p>Keep the <code>git undo</code> command in the back of your mind in case you need it.</p><h3 id="reword-a-commit-message-with-span-classnowrapgit-rewordspan-span-classnowrapgit-branchlessspan">Reword a commit message with <span class="nowrap">&ldquo;git reword&rdquo;</span> <span class="nowrap">(git-branchless)</span></h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git reword 4f69280
</code></pre></div><p>This will open the editor to edit the commit message. After saving, the stack will be updated:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ b61494d 1s update cache package
┃
◯ <span class="m">2016397</span> 1s implement email package
┃
● a980f8c 1s implement user signup
</code></pre></div><h3 id="moving-commits-around-with-git-move-git-branchless">Moving commits around with &ldquo;git move&rdquo; (git-branchless)</h3><p>You can rebase a commit on top of another commit with <code>git move</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git move -s <span class="m">2016397</span> -d bf31e38
</code></pre></div><p>This will rebase the stack including the email commit and the signup commit on to main. After the command, the stack will look like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl         <span class="c1"># alias: gg</span>
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┣━┓
┃ ◯ <span class="m">2016397</span> 1s implement email package
┃ ┃
┃ ● f798adb 1s implement user signup
┃
◯ b61494d 1m update cache package
</code></pre></div><h3 id="checkout-the-cache-commit-and-make-changes-with-span-classnowrapgit-amendspan-span-classnowrapgit-branchlessspan">Checkout the cache commit and make changes with <span class="nowrap">&ldquo;git amend&rdquo;</span> <span class="nowrap">(git-branchless)</span></h3><p>Let&rsquo;s checkout the cache commit and make some changes:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git checkout 4f69280    <span class="c1"># alias: gco</span>
$ vim lib/cache/cache.go  <span class="c1"># make some changes to the cache package</span>
$ git add -A              <span class="c1"># alias: ga</span>
$ git amend               <span class="c1"># amend the changes to the cache commit (git-branchless)</span>
</code></pre></div><p>Now run <code>git sl</code> (alias <code>gg</code>) to see the stack:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ a9ca4ac 1s update cache package
┃
◯ b6d516d 1s implement email package
┃
● 8a40bd4 1s implement user signup
</code></pre></div><p>The two other commits has been rebased and stacked nicely on top of the cache commit.<br><strong>Alias</strong> <code>gco=&quot;git checkout&quot;</code><br><strong>Alias</strong> <code>ga=&quot;git add -A&quot;</code><br><strong>Alias</strong> <code>gaa=&quot;git add -A &amp;&amp; git amend&quot;</code></p><h3 id="resolving-conflicts-while-rebasing">Resolving conflicts while rebasing</h3><p>Sometimes, you may run into a conflict. The error message will suggest to use <code>--merge</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">Attempting rebase in-memory...
This operation would cause a merge conflict:
• (1 conflicting file) 2016397 implement email package
To resolve merge conflicts, retry this operation with the --merge option.
</code></pre></div><p>Let&rsquo;s run <code>git move</code> with <code>--merge</code>, resolve the conflict, and continue with <span class="nowrap"><code>git rebase --continue</code> (alias <code>grbc</code>):</span></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git move -s <span class="m">2016397</span> -d bf31e38 --merge   <span class="c1"># retry with --merge</span>
$ git status                               <span class="c1"># alias: gs</span>
$ vim lib/cache/cache.go                   <span class="c1"># resolve conflict</span>
$ git add -A                               <span class="c1"># alias: ga</span>
$ git rebase --continue                    <span class="c1"># alias: grbc</span>
</code></pre></div><p><strong>Alias</strong> <code>gs=&quot;git status&quot;</code><br><strong>Alias</strong> <code>ga=&quot;git add -A&quot;</code><br><strong>Alias</strong> <code>grbc=&quot;git rebase --continue&quot;</code></p><h3 id="make-changes-to-multiple-commits-with-span-classnowrapgit-autofixupspan-span-classnowrapgit-autofixupspan">Make changes to multiple commits with <span class="nowrap">&ldquo;git autofixup&rdquo;</span> <span class="nowrap">(git-autofixup)</span></h3><p>Let&rsquo;s make some changes:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">git checkout oliver/signup             <span class="c1"># checkout the sign up code</span>
vim features/signup/signup.go          <span class="c1"># make changes to signup package</span>
vim lib/email/email.go                 <span class="c1"># make changes to email package</span>
</code></pre></div><p>Now, add the changes as <code>fixup!</code> commits. You will notice that there are <span class="nowrap">2 new commits</span> with the <code>fixup!</code> prefix. They are associated with the corresponding original commits and will be used to update them later.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git add -A                                 <span class="c1"># alias: gaa                     </span>
$ git autofixup origin/main                  <span class="c1"># alias: gfix</span>
$ git sl                                     <span class="c1"># alias: gg</span>
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ a9ca4ac 4m update cache package
┃
◯ b6d516d 2m implement email package
┃
◯ 8a40bd4 2m implement user signup
┃
◯ 5f4da9b 1m fixup! implement user signup
┃
● c606fe9 1m fixup! implement email package
</code></pre></div><p>Finally, run <code>git rebase --interactive --autosquash origin/main</code> <span class="nowrap">(alias <code>grom</code>)</span> to absorb the changes into the original commits:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git rebase --interactive --autosquash origin/main   <span class="c1"># alias: grom</span>
$ git sl                                              <span class="c1"># alias: gg</span>
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ a9ca4ac 6m update cache package
┃
◯ 5bdd29e 1m implement email package
┃
◯ aa025d1 1m implement user signup
</code></pre></div><p><strong>Alias</strong> <code>gfix=&quot;git autofixup origin/main&quot;</code><br><strong>Alias</strong> <code>grom=&quot;git rebase --interactive --autosquash origin/main&quot;</code></p><h3 id="pull-commits-from-remote-and-rebase-your-local-commits-on-top-of-originmain">Pull commits from remote and rebase your local commits on top of origin/main</h3><p>I will call the alias <code>gsync</code> to do all the work:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># in .bashrc or .zshrc config</span>
<span class="nb">alias</span> <span class="nv">gu</span><span class="o">=</span><span class="s2">&#34;git pull --rebase --prune </span><span class="nv">$@</span><span class="s2"> &amp;&amp; git submodule update --init --recursive&#34;</span>          
<span class="nb">alias</span> <span class="nv">gsync</span><span class="o">=</span><span class="s2">&#34;git checkout main &amp;&amp; gu &amp;&amp; git sync &amp;&amp; git checkout origin/main&#34;</span>

<span class="c1"># call it</span>
$ <span class="nb">cd</span> my-project
$ git add -A <span class="o">&amp;&amp;</span> git stash    <span class="c1"># clean up the repository before running gsync</span>
$ gsync
</code></pre></div><p>It will do the following steps:</p><ul><li>Check out the local <code>main</code> branch.</li><li>Pull commits from remote repository to the local <code>main</code> branch.</li><li>Update git submodules.</li><li>Call <code>git sync</code> from git-branchless to rebase local stacked commits.</li><li>Finally, checkout <code>origin/main</code>.</li></ul><h3 id="push-all-commits-and-create-stacked-prs-with-span-classnowrapgit-prspan-span-classnowrapgit-prspan">Push all commits and create stacked PRs with <span class="nowrap">&ldquo;git pr&rdquo;</span> <span class="nowrap">(git-pr)</span></h3><p>When everything is ready, let&rsquo;s run <code>git pr</code> to push all the commits to GitHub. A PR will be created for each commit. They will be stacked onto each other:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ a9ca4ac 6m update cache package
┃
◯ 5bdd29e 1m implement email package
┃
◯ aa025d1 1m implement user signup

$ git add -A <span class="o">&amp;&amp;</span> git stash    <span class="c1"># clean up the repository before running git pr</span>
$ git checkout aa025d1       <span class="c1"># checkout the last commit of the stack</span>
$ git pr                     <span class="c1"># submit all PRs to GitHub</span>
</code></pre></div><p>Here&rsquo;s how a PR in the stack will look like:</p><ul><li>A review link &ldquo;👉 <strong>REVIEW</strong> 👈&rdquo;, which reviewers can click to access the corresponding commit and add comments.</li><li>A list of all PRs or commits for that stack.</li></ul><p><img src="1.png" alt=""></p><p><strong>Tips for using &ldquo;git-pr&rdquo;</strong></p><ul><li><p>Each commit in the stack will become a separate PR.</p></li><li><p>An attribute <code>Remote-Ref: iOliverNguyen/1be640ba</code> will be appended to your commit message. It must be keep separate to the commit body with a blank line.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">[draft][flow][compiler] current output of loop flow

Summary
---
Run tests inside the flow compiler package
and check the `testoutput` directory.

Remote-Ref: iOliverNguyen/1be640ba
</code></pre></div></li><li><p>You can not use <code>#</code> to input header in the message, because git will see it as comments and ignore. Instead, use <code>----</code> and <code>====</code> to make headers.</p></li><li><p>Add <code>[draft]</code> to the commit message title before running <code>git pr</code> to set the PR status to draft. Remove <code>[draft]</code> to change back.</p></li><li><p>No need to wait for other people PR to get merged to main, because your stack can <em>include commits from other people</em>. When run <span class="nowrap"><code>git pr</code></span>, only your commits get submitted as new PRs.</p></li></ul><h3 id="question-i-accidentally-amended-all-my-changes-to-the-last-commit-how-to-split-it">Question: I accidentally amended all my changes to the last commit. How to split it?</h3><p>Suppose we have this stack. And we were at the last commit, made changes to files related to both <em>cache</em> and <em>email</em> package:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git sl
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ a9ca4ac 10m update cache package
┃
◯ b6d516d 10m implement email package
┃
● 8a40bd4 10m implement user signup
</code></pre></div><p>Let&rsquo;s fix it:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git checkout 8a40bd4     <span class="c1"># checkout the last commit                     (alias: gco)</span>
$ git add -A <span class="o">&amp;&amp;</span> git amend  <span class="c1"># and amend all the changes to the last commit (alias: gaa)</span>

$ git checkout a9ca4ac                 <span class="c1"># checkout the first commit (cache)</span>
$ git checkout 8a40bd4 -- lib/cache    <span class="c1"># copy all changed file in cache package</span>
$ git add -A <span class="o">&amp;&amp;</span> git amend              <span class="c1"># amend it to the commit</span>

$ git sl                               <span class="c1"># check the stack again, with new commit hash</span>
◇ bf31e38 3d <span class="o">(</span>main<span class="o">)</span> update something on main
┃
◯ f4e0713 1s update cache package
┃
◯ 0980f8c 1s implement email package
┃
● f7d1e37 1s implement user signup

$ git checkout 0980f8c                 <span class="c1"># checkout the second commit (email)</span>
$ git checkout f7d1e37 -- pkg/email    <span class="c1"># and do that again</span>
$ git add -A <span class="o">&amp;&amp;</span> git amend
</code></pre></div><p>Now, all changes will be in place. The cache changes get amended to the <em>cache</em> commit and the email changes get amened to the <em>email</em> commit. The last commit no longer contains changes from other commits. 🎉</p><h3 id="bonus-some-useful-aliases">Bonus: Some useful aliases</h3><p>Here are a list of my frequently used aliases:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">alias</span> <span class="nv">g</span><span class="o">=</span><span class="s1">&#39;git&#39;</span>
<span class="nb">alias</span> <span class="nv">gg</span><span class="o">=</span><span class="s1">&#39;git sl&#39;</span>                      <span class="c1"># smart logs</span>
<span class="nb">alias</span> <span class="nv">gs</span><span class="o">=</span><span class="s1">&#39;git status&#39;</span>
<span class="nb">alias</span> <span class="nv">gp</span><span class="o">=</span><span class="s1">&#39;git push -u&#39;</span>
<span class="nb">alias</span> <span class="nv">ga</span><span class="o">=</span><span class="s1">&#39;git add&#39;</span>
<span class="nb">alias</span> <span class="nv">gaa</span><span class="o">=</span><span class="s1">&#39;git add -A &amp;&amp; git amend&#39;</span>
<span class="nb">alias</span> <span class="nv">gcm</span><span class="o">=</span><span class="s1">&#39;git commit&#39;</span>
<span class="nb">alias</span> <span class="nv">gco</span><span class="o">=</span><span class="s1">&#39;git checkout&#39;</span>
<span class="nb">alias</span> <span class="nv">gcp</span><span class="o">=</span><span class="s1">&#39;git cherry-pick&#39;</span>
<span class="nb">alias</span> <span class="nv">grs</span><span class="o">=</span><span class="s1">&#39;git reset --mixed HEAD~1 ; gg ; gs&#39;</span>
<span class="nb">alias</span> <span class="nv">gcom</span><span class="o">=</span><span class="s1">&#39;git checkout origin/main&#39;</span>

<span class="c1"># checkout the main branch</span>
<span class="nb">alias</span> <span class="nv">gmain</span><span class="o">=</span><span class="s1">&#39;git checkout main&#39;</span>

<span class="c1"># checkout the latest commit from the main branch and show commit tree</span>
<span class="nb">alias</span> <span class="nv">gm</span><span class="o">=</span><span class="s1">&#39;git checkout origin/main ; gg&#39;</span>

<span class="c1"># commit the current changes as fixup commits</span>
<span class="nb">alias</span> <span class="nv">gfix</span><span class="o">=</span><span class="s1">&#39;git autofixup origin/main&#39;</span>

<span class="c1"># rebase the current branch on the origin/main branch, and squash fixup commits</span>
<span class="nb">alias</span> <span class="nv">grom</span><span class="o">=</span><span class="s1">&#39;git rebase --interactive --autosquash origin/main&#39;</span>

<span class="c1"># pull, rebase, and update submodules</span>
<span class="nb">alias</span> <span class="nv">gu</span><span class="o">=</span><span class="s1">&#39;git pull --rebase --prune $@ &amp;&amp; git submodule update --init --recursive&#39;</span>

<span class="c1"># checkout the main branch, pull, rebase, and checkout the main commit</span>
<span class="nb">alias</span> <span class="nv">gsync</span><span class="o">=</span><span class="s1">&#39;gmain &amp;&amp; gu &amp;&amp; git sync &amp;&amp; gcom &amp;&amp; gg&#39;</span>
</code></pre></div><h2 id="recap">Recap</h2><p>🎉 That&rsquo;s it! Now we can work with stacked PRs easily within the git world, compatible with other familiar git commands. And when something goes wrong, at least we can still be able to fix it with our git knowledge and plenty of available tools.</p><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#the-stacked-prs-workflow-with-git">The stacked PRs workflow with git</a>\n      <ul>\n        <li><a href="#initialize-git-branchless">Initialize git-branchless</a></li>\n        <li><a href="#view-stacked-commits-with-git-sl-git-branchless">View stacked commits with &ldquo;git sl&rdquo; (git-branchless)</a></li>\n        <li><a href="#delete-your-local-branches-and-hide-unused-commit-with-span-classnowrapgit-hidespan-span-classnowrapgit-branchlessspan">Delete your local branches and hide unused commit with <span class="nowrap">&ldquo;git hide&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li>\n        <li><a href="#undo-mistake-with-git-undo-span-classnowrapgit-branchlessspan">undo mistake with &ldquo;git undo&rdquo; <span class="nowrap">(git-branchless)</span></a></li>\n        <li><a href="#reword-a-commit-message-with-span-classnowrapgit-rewordspan-span-classnowrapgit-branchlessspan">Reword a commit message with <span class="nowrap">&ldquo;git reword&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li>\n        <li><a href="#moving-commits-around-with-git-move-git-branchless">Moving commits around with &ldquo;git move&rdquo; (git-branchless)</a></li>\n        <li><a href="#checkout-the-cache-commit-and-make-changes-with-span-classnowrapgit-amendspan-span-classnowrapgit-branchlessspan">Checkout the cache commit and make changes with <span class="nowrap">&ldquo;git amend&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li>\n        <li><a href="#resolving-conflicts-while-rebasing">Resolving conflicts while rebasing</a></li>\n        <li><a href="#make-changes-to-multiple-commits-with-span-classnowrapgit-autofixupspan-span-classnowrapgit-autofixupspan">Make changes to multiple commits with <span class="nowrap">&ldquo;git autofixup&rdquo;</span> <span class="nowrap">(git-autofixup)</span></a></li>\n        <li><a href="#pull-commits-from-remote-and-rebase-your-local-commits-on-top-of-originmain">Pull commits from remote and rebase your local commits on top of origin/main</a></li>\n        <li><a href="#push-all-commits-and-create-stacked-prs-with-span-classnowrapgit-prspan-span-classnowrapgit-prspan">Push all commits and create stacked PRs with <span class="nowrap">&ldquo;git pr&rdquo;</span> <span class="nowrap">(git-pr)</span></a></li>\n        <li><a href="#question-i-accidentally-amended-all-my-changes-to-the-last-commit-how-to-split-it">Question: I accidentally amended all my changes to the last commit. How to split it?</a></li>\n        <li><a href="#bonus-some-useful-aliases">Bonus: Some useful aliases</a></li>\n      </ul>\n    </li>\n    <li><a href="#recap">Recap</a></li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Working with Stacked PRs using git-branchless, git-autofixup, and git-pr</a></div><nav id="TableOfContents"><ul><li><a href="#the-stacked-prs-workflow-with-git">The stacked PRs workflow with git</a><ul><li><a href="#initialize-git-branchless">Initialize git-branchless</a></li><li><a href="#view-stacked-commits-with-git-sl-git-branchless">View stacked commits with &ldquo;git sl&rdquo; (git-branchless)</a></li><li><a href="#delete-your-local-branches-and-hide-unused-commit-with-span-classnowrapgit-hidespan-span-classnowrapgit-branchlessspan">Delete your local branches and hide unused commit with <span class="nowrap">&ldquo;git hide&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li><li><a href="#undo-mistake-with-git-undo-span-classnowrapgit-branchlessspan">undo mistake with &ldquo;git undo&rdquo; <span class="nowrap">(git-branchless)</span></a></li><li><a href="#reword-a-commit-message-with-span-classnowrapgit-rewordspan-span-classnowrapgit-branchlessspan">Reword a commit message with <span class="nowrap">&ldquo;git reword&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li><li><a href="#moving-commits-around-with-git-move-git-branchless">Moving commits around with &ldquo;git move&rdquo; (git-branchless)</a></li><li><a href="#checkout-the-cache-commit-and-make-changes-with-span-classnowrapgit-amendspan-span-classnowrapgit-branchlessspan">Checkout the cache commit and make changes with <span class="nowrap">&ldquo;git amend&rdquo;</span> <span class="nowrap">(git-branchless)</span></a></li><li><a href="#resolving-conflicts-while-rebasing">Resolving conflicts while rebasing</a></li><li><a href="#make-changes-to-multiple-commits-with-span-classnowrapgit-autofixupspan-span-classnowrapgit-autofixupspan">Make changes to multiple commits with <span class="nowrap">&ldquo;git autofixup&rdquo;</span> <span class="nowrap">(git-autofixup)</span></a></li><li><a href="#pull-commits-from-remote-and-rebase-your-local-commits-on-top-of-originmain">Pull commits from remote and rebase your local commits on top of origin/main</a></li><li><a href="#push-all-commits-and-create-stacked-prs-with-span-classnowrapgit-prspan-span-classnowrapgit-prspan">Push all commits and create stacked PRs with <span class="nowrap">&ldquo;git pr&rdquo;</span> <span class="nowrap">(git-pr)</span></a></li><li><a href="#question-i-accidentally-amended-all-my-changes-to-the-last-commit-how-to-split-it">Question: I accidentally amended all my changes to the last commit. How to split it?</a></li><li><a href="#bonus-some-useful-aliases">Bonus: Some useful aliases</a></li></ul></li><li><a href="#recap">Recap</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fstacked.prs%2f&title=Working%20with%20Stacked%20PRs%20using%20git-branchless%2c%20git-autofixup%2c%20and%20git-pr"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fstacked.prs%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fstacked.prs%2f&text=Working%20with%20Stacked%20PRs%20using%20git-branchless%2c%20git-autofixup%2c%20and%20git-pr"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fstacked.prs%2f&title=Working%20with%20Stacked%20PRs%20using%20git-branchless%2c%20git-autofixup%2c%20and%20git-pr"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fstacked.prs%2f&t=Working%20with%20Stacked%20PRs%20using%20git-branchless%2c%20git-autofixup%2c%20and%20git-pr"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>