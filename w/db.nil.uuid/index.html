<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>TIL: Beware of Nil UUID when updating database with gorm! | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="TIL: Beware of Nil UUID when updating database with gorm!"><meta property="og:description" content="WHERE conditions required At work, we are using gorm for dealing with database. It&rsquo;s a popular SQL manipulation library in Go.
But recently, we got a scary error:
can not update row: id=00000000-0000-0000-0000-000000000000 WHERE conditions required Which happened from this code snippet:
db, _ := gorm.Open(...) paper := &amp;Paper{ ID: updateID, Name: &#34;new name&#34;, } db.Update(paper) The above code will generate the following SQL statement:
UPDATE &#34;paper&#34; SET &#34;name&#34; = $1, &#34;updated_at&#34; = $2 WHERE &#34;paper&#34;."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/db.nil.uuid/"><meta property="og:image" content="https://iOliverNguyen.github.io/w/db.nil.uuid/_cover.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2022-03-30T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-30T00:00:00+00:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://iOliverNguyen.github.io/w/db.nil.uuid/_cover.png"><meta name="twitter:title" content="TIL: Beware of Nil UUID when updating database with gorm!"><meta name="twitter:description" content="WHERE conditions required At work, we are using gorm for dealing with database. It&rsquo;s a popular SQL manipulation library in Go.
But recently, we got a scary error:
can not update row: id=00000000-0000-0000-0000-000000000000 WHERE conditions required Which happened from this code snippet:
db, _ := gorm.Open(...) paper := &amp;Paper{ ID: updateID, Name: &#34;new name&#34;, } db.Update(paper) The above code will generate the following SQL statement:
UPDATE &#34;paper&#34; SET &#34;name&#34; = $1, &#34;updated_at&#34; = $2 WHERE &#34;paper&#34;."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/db.nil.uuid/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">TIL: Beware of Nil UUID when updating database with gorm!</h1><div class="meta"><div class="postdate"><time datetime="2022-03-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-03-30</time></div><div class="article-tag">&nbsp;Â· <a class="tag-link" href="/w/#db" rel="tag">db</a></div></div></header><div class="content" itemprop="articleBody"><h2 id="where-conditions-required">WHERE conditions required</h2><p>At work, we are using <a href="https://gorm.io/index.html">gorm</a> for dealing with database. It&rsquo;s a popular SQL manipulation library in Go.</p><p>But recently, we got a scary error:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">can not update row: id=00000000-0000-0000-0000-000000000000
WHERE conditions required
</code></pre></div><p>Which happened from this code snippet:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="nx">paper</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Paper</span><span class="p">{</span>
	<span class="nx">ID</span><span class="p">:</span>   <span class="nx">updateID</span><span class="p">,</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;new name&#34;</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
</code></pre></div><p>The above code will generate the following SQL statement:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-postgresql" data-lang="postgresql"><span class="k">UPDATE</span> <span class="s">&#34;paper&#34;</span> <span class="k">SET</span> <span class="s">&#34;name&#34;</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span> <span class="o">=</span> <span class="nv">$2</span>
<span class="k">WHERE</span> <span class="s">&#34;paper&#34;</span><span class="mf">.</span><span class="s">&#34;deleted_at&#34;</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="s">&#34;id&#34;</span> <span class="o">=</span> <span class="nv">$3</span>
</code></pre></div><p>Everything looks fine, right? The correct SQL statement is generated. The paper with given id is updated. Unit test passes. The code was deployed to production. Customer is happy. And we can sleep well.</p><p>Think again! One day, we got the above error!</p><p>What actually happens is that there is a record with <code>id = 00000000-0000-0000-0000-000000000000</code> in the database. The <code>updateID</code> is taken from that record, which in turn is empty. And since gorm happily ignores empty fields when updating, it&rsquo;ll give us this SQL statement instead:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-postgresql" data-lang="postgresql"><span class="k">UPDATE</span> <span class="s">&#34;paper&#34;</span> <span class="k">SET</span> <span class="s">&#34;name&#34;</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span> <span class="o">=</span> <span class="nv">$2</span>
<span class="k">WHERE</span> <span class="s">&#34;paper&#34;</span><span class="mf">.</span><span class="s">&#34;deleted_at&#34;</span> <span class="k">IS</span> <span class="k">NULL</span>
</code></pre></div><p>Luckily for us, there is no other where conditions, so that error was returned: <code>WHERE conditions required</code>.</p><h2 id="but-if-the-code-were-written-slightly-different">But if the code were written slightly different</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">paper</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Paper</span><span class="p">{</span>
	<span class="nx">ID</span><span class="p">:</span>   <span class="nx">updateID</span><span class="p">,</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;new name&#34;</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;account_id = ?&#34;</span><span class="p">).</span><span class="nf">Update</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
</code></pre></div><p>In this case, the generated SQL statement will be:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-postgresql" data-lang="postgresql"><span class="k">UPDATE</span> <span class="s">&#34;paper&#34;</span> <span class="k">SET</span> <span class="s">&#34;name&#34;</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span> <span class="o">=</span> <span class="nv">$2</span>
<span class="k">WHERE</span> <span class="s">&#34;account_id&#34;</span> <span class="o">=</span> <span class="nv">$3</span> <span class="k">AND</span> <span class="s">&#34;paper&#34;</span><span class="mf">.</span><span class="s">&#34;deleted_at&#34;</span> <span class="k">IS</span> <span class="k">NULL</span>
</code></pre></div><p>How scary it is! All records for that account will be updated with the new name! And gorm won&rsquo;t save us this time, since there is a <code>.Where()</code> condition already!</p><h2 id="lesson-learned">Lesson learned</h2><h3 id="lets-always-require-where-id--">Let&rsquo;s always require <code>where id = ?</code></h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ? AND account_id = ?&#34;</span><span class="p">).</span><span class="nf">Update</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span>
</code></pre></div><h3 id="or-validate-that-the-uuid-can-not-be-nil">Or validate that the UUID can not be nil</h3><p>By checking for nil value when implementing the <a href="https://pkg.go.dev/database/sql/driver#Valuer"><code>Valuer</code> interface</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">id</span> <span class="nx">UUID</span><span class="p">)</span> <span class="nf">Value</span><span class="p">()</span> <span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">Nil</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;nil uuid&#34;</span><span class="p">)</span>	
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">marshal</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Thanks for reading. And we can sleep well now. Hopefully so! ðŸ¥º</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">A lesson learned when we have a UUID record as Nil in the database.<a href="https://t.co/NfIM4m6GkT">https://t.co/NfIM4m6GkT</a></p>&mdash; Oliver N (@olvrng) <a href="https://twitter.com/olvrng/status/1508999530767089664?ref_src=twsrc%5Etfw">March 30, 2022</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://twitter.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#where-conditions-required">WHERE conditions required</a></li>\n    <li><a href="#but-if-the-code-were-written-slightly-different">But if the code were written slightly different</a></li>\n    <li><a href="#lesson-learned">Lesson learned</a>\n      <ul>\n        <li><a href="#lets-always-require-where-id--">Let&rsquo;s always require <code>where id = ?</code></a></li>\n        <li><a href="#or-validate-that-the-uuid-can-not-be-nil">Or validate that the UUID can not be nil</a></li>\n      </ul>\n    </li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">TIL: Beware of Nil UUID when updating database with gorm!</a></div><nav id="TableOfContents"><ul><li><a href="#where-conditions-required">WHERE conditions required</a></li><li><a href="#but-if-the-code-were-written-slightly-different">But if the code were written slightly different</a></li><li><a href="#lesson-learned">Lesson learned</a><ul><li><a href="#lets-always-require-where-id--">Let&rsquo;s always require <code>where id = ?</code></a></li><li><a href="#or-validate-that-the-uuid-can-not-be-nil">Or validate that the UUID can not be nil</a></li></ul></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdb.nil.uuid%2f&title=TIL%3a%20Beware%20of%20Nil%20UUID%20when%20updating%20database%20with%20gorm%21"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdb.nil.uuid%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdb.nil.uuid%2f&text=TIL%3a%20Beware%20of%20Nil%20UUID%20when%20updating%20database%20with%20gorm%21"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdb.nil.uuid%2f&title=TIL%3a%20Beware%20of%20Nil%20UUID%20when%20updating%20database%20with%20gorm%21"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdb.nil.uuid%2f&t=TIL%3a%20Beware%20of%20Nil%20UUID%20when%20updating%20database%20with%20gorm%21"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2023 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>