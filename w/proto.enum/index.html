<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Validate zero enum value in Protocol Buffer | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Validate zero enum value in Protocol Buffer"><meta property="og:description" content="How to validate that a Protobuf message does not contain enum fields with zero value? Turn out that is not supported directly by Protobuf! We need to look into how protojson package is implemented.
More and more companies are adopting gRPC with Protobuf for communication between internal services. It has the benefits of high performance, supporting multiple programming languages, and being backed by Google with a great ecosystem around.
For communication with front-end and external services, Protobuf can be marshaled to JSON format."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/proto.enum/"><meta property="og:image" content="https://iOliverNguyen.github.io/w/proto.enum/_cover.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2022-03-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-01T00:00:00+00:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://iOliverNguyen.github.io/w/proto.enum/_cover.png"><meta name="twitter:title" content="Validate zero enum value in Protocol Buffer"><meta name="twitter:description" content="How to validate that a Protobuf message does not contain enum fields with zero value? Turn out that is not supported directly by Protobuf! We need to look into how protojson package is implemented.
More and more companies are adopting gRPC with Protobuf for communication between internal services. It has the benefits of high performance, supporting multiple programming languages, and being backed by Google with a great ecosystem around.
For communication with front-end and external services, Protobuf can be marshaled to JSON format."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/proto.enum/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Validate zero enum value in Protocol Buffer</h1><div class="meta"><div class="postdate"><time datetime="2022-03-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-03-01</time></div><div class="article-tag">&nbsp;Â· <a class="tag-link" href="/w/#protobuf" rel="tag">protobuf</a></div><div class="published-at">published at <a target="_blank" href="https://hackernoon.com/validating-zero-enum-value-in-the-protocol-buffer">Hacker Noon</a> , <a target="_blank" href="https://betterprogramming.pub/validate-zero-enum-value-in-protocol-buffer-dbed0d9ecac4">Better Programming</a></div></div></header><div class="content" itemprop="articleBody"><p><em>How to validate that a Protobuf message does not contain enum fields with zero value? Turn out that is not supported directly by Protobuf! We need to look into how <code>protojson</code> package is implemented.</em></p><p>More and more companies are adopting gRPC with <a href="https://developers.google.com/protocol-buffers">Protobuf</a> for communication between internal services. It has the benefits of high performance, supporting multiple programming languages, and being backed by Google with a great ecosystem around.</p><p>For communication with front-end and external services, Protobuf can be marshaled to JSON format. The browser only understands JSON format, and we can not expect other companies to consume Protobuf directly from us. <em>(Of course, you can, if you are <a href="https://github.com/googleapis/googleapis">big enough</a>!)</em></p><h3 id="lets-talk-about-enum-and-some-problems-that-we-encountered-recently-with-it-div-classaltlets-talk-about-enumb">Let&rsquo;s talk about enum and some problems that we encountered recently with it.<div class="alt">Let&rsquo;s talk about enum</div></h3><p><em>Sample code is written in Go.</em></p><p>From the Protobuf <a href="https://developers.google.com/protocol-buffers/docs/style#enums">style guide</a>, the zero value enum should have the suffix <code>UNSPECIFIED</code>. It&rsquo;s because enum is implemented as a <code>uint32</code>, and the value <code>0</code> is considered as, well, unspecified. It&rsquo;s similar to <code>nil</code> for a message or an empty string. When encoding Protobuf as JSON, a <code>nil</code> message, an <code>UNSPECIFIED</code> enum, or an empty string is ignored.</p><p>We were following that convention, until someday, we did not.</p><p>When sending external webhook messages, we decided to not use <code>0</code> as <code>UNSPECIFIED</code>. One reason is that we are using <code>EmitUnpopulated: true</code> to ensure that all fields are included in the JSON representation when sending webhook messages to external parties. <strong>And we don&rsquo;t want that <code>UNSPECIFIED</code> value appears in the webhook messages, if somehow we forget to set an enum field to 0</strong>. Unit tests can not catch all the mistakes; we engineers know that.</p><p>This causes a lot of trouble, so we had to revert and make the value <code>0</code> as <code>UNSPECIFIED</code> again. One problem is that it forces the use of <code>EmitUnpopulated: true</code> everywhere! And there are places where we don&rsquo;t want to emit all unpopulated fields. Like calling some third-party APIs. Some messages mix between <code>UNSPECIFIED</code> enums and non-<code>UNSPECIFIED</code> enums; there are no ways to send the correct format with that. Use <code>EmitUnpopulated: true</code>, the third-party APIs don&rsquo;t understand <code>UNSPECIFIED</code>; use <code>EmitUnpopulated: false</code> and some required fields with non-<code>UNSPECIFIED</code> enums are omitted. Of course, they can all be refactored away, but it should be simpler to just force the use of <code>UNSPECIFIED</code> at the beginning.</p><h3 id="well-why-not-just-verify-that-all-enum-fields-are-not-set-to-0-in-webhook-messages-you-may-ask-div-classalttry-checking-for-zero-valueb">Well, why not just verify that all enum fields are not set to 0 in webhook messages? You may ask.<div class="alt">Try checking for zero value</div></h3><p>Turn out there are no simple ways to do that in Protobuf 3!</p><p>In Protobuf 2, there is <a href="https://developers.google.com/protocol-buffers/docs/proto#specifying-rules"><code>required</code> option</a> to prevent a field to be unset. This option was removed in Protobuf 3, because it prevents refactoring for removing fields. If we forgot to update every service to remove that no-longer-used <code>required</code> field, especially in a company with multiple teams working together, the messages will be dropped unintentionally. It should be better not to require it upfront. (<a href="https://developers.google.com/protocol-buffers/docs/proto#specifying-rules"><em>more</em></a>)</p><p>In Protobuf 3, there was <a href="https://pkg.go.dev/github.com/golang/protobuf/jsonpb#JSONPBMarshaler"><code>jsonpb.JSONPBMarshaler</code> interface</a>. We can simply implement that interface for all enums to return error upon seeing a zero value. But again, it was removed! As a protocol, we should minimize the customization as much as possible. Otherwise, that customization will have to be implemented and maintained in all different languages across different teams!</p><h3 id="so-how-to-validate-zero-value-in-enum-fields-div-classaltprevent-zero-value-in-enum-fieldsb">So, how to validate zero value in enum fields?<div class="alt">Prevent zero value in enum fields</div></h3><p>We&rsquo;ll have to reach the reflection package. The <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect#Message"><code>protoreflect.Message</code></a> interface has <code>Range()</code> method for iterating over every populated field. We can use that method to verify that there are no enum fields with zero&hellip; Oh, wait. It only iterates over <em>populated fields</em>. So it won&rsquo;t detect the zero value in enum!</p><p>But the function <a href="https://pkg.go.dev/google.golang.org/protobuf/encoding/protojson#Marshal"><code>protojson.Marshal()</code></a> can still emit unpopulated fields with <a href="https://pkg.go.dev/google.golang.org/protobuf/encoding/protojson#MarshalOptions"><code>EmitUnpopulated</code> option</a>. How does it implement that? Dive into <a href="https://pkg.go.dev/encoding/json"><code>encoding/protojson</code></a>, there is a code snippet for iterating over <em>unpopulated fields</em> (<a href="https://github.com/protocolbuffers/protobuf-go/blob/master/encoding/protojson/encode.go#L174-L197"><em>source</em></a>). Let&rsquo;s steal it:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// unpopulatedFieldRanger wraps a protoreflect.Message and modifies its Range
</span><span class="c1">// method to additionally iterate over unpopulated fields.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">unpopulatedFieldRanger</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">pref</span><span class="p">.</span><span class="nx">Message</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">unpopulatedFieldRanger</span><span class="p">)</span> <span class="nf">Range</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="nx">pref</span><span class="p">.</span><span class="nx">FieldDescriptor</span><span class="p">,</span> <span class="nx">pref</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fds</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Descriptor</span><span class="p">().</span><span class="nf">Fields</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">fds</span><span class="p">.</span><span class="nf">Len</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">fd</span> <span class="o">:=</span> <span class="nx">fds</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Has</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="o">||</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">ContainingOneof</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">continue</span> <span class="c1">// ignore populated fields and fields within a oneofs
</span><span class="c1"></span>		<span class="p">}</span>

		<span class="nx">v</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
		<span class="nx">isProto2Scalar</span> <span class="o">:=</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">Syntax</span><span class="p">()</span> <span class="o">==</span> <span class="nx">pref</span><span class="p">.</span><span class="nx">Proto2</span> <span class="o">&amp;&amp;</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">Default</span><span class="p">().</span><span class="nf">IsValid</span><span class="p">()</span>
		<span class="nx">isSingularMessage</span> <span class="o">:=</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">Cardinality</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">pref</span><span class="p">.</span><span class="nx">Repeated</span> <span class="o">&amp;&amp;</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">Message</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span>
		<span class="k">if</span> <span class="nx">isProto2Scalar</span> <span class="o">||</span> <span class="nx">isSingularMessage</span> <span class="p">{</span>
			<span class="nx">v</span> <span class="p">=</span> <span class="nx">pref</span><span class="p">.</span><span class="nx">Value</span><span class="p">{}</span> <span class="c1">// use invalid value to emit null
</span><span class="c1"></span>		<span class="p">}</span>
		<span class="k">if</span> <span class="p">!</span><span class="nf">f</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">m</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>What the above code does is iterating over additional fields, by looping over <code>protoreflect.Message.Descriptor().Fields()</code>. Fields within <code>oneof</code> fields are skipped. Unpopulated singular <code>message</code> fields are set as <code>invalid</code> (think of it as <code>null</code> in generated JSON) before being sent to the input function.</p><p>Still a bit more code to write, like implementing a traveling method for iterating over all different Protobuf types: message, array (repeated), dynamic <a href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#google.protobuf.Struct">Struct</a>, and of course, enum. But it&rsquo;s solvable. And I can take a rest now.</p><p>Thanks for reading! If you have a better way to do that, please let me know by adding your reply below ð</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">How to validate that an enum value field in Protobuf can not be empty? Turn out that is not supported directly by Protobuf! We need to look into how protojson is implemented.<br><br>My latest article about <a href="https://x.com/hashtag/protobuf?src=hash&amp;ref_src=twsrc%5Etfw">#protobuf</a> <a href="https://x.com/hashtag/go?src=hash&amp;ref_src=twsrc%5Etfw">#go</a><br><a href="https://t.co/d5DycxeZID">https://t.co/d5DycxeZID</a></p>&mdash; Oliver Nguyen (@_OliverNguyen) <a href="https://x.com/_OliverNguyen/status/1498470060826181634?ref_src=twsrc%5Etfw"></a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li>\n      <ul>\n        <li><a href="#lets-talk-about-enum-and-some-problems-that-we-encountered-recently-with-it-div-classaltlets-talk-about-enumb">Let&rsquo;s talk about enum and some problems that we encountered recently with it. <div class="alt">Let&rsquo;s talk about enum</b></a></li>\n        <li><a href="#well-why-not-just-verify-that-all-enum-fields-are-not-set-to-0-in-webhook-messages-you-may-ask-div-classalttry-checking-for-zero-valueb">Well, why not just verify that all enum fields are not set to 0 in webhook messages? You may ask. <div class="alt">Try checking for zero value</b></a></li>\n        <li><a href="#so-how-to-validate-zero-value-in-enum-fields-div-classaltprevent-zero-value-in-enum-fieldsb">So, how to validate zero value in enum fields? <div class="alt">Prevent zero value in enum fields</b></a></li>\n      </ul>\n    </li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Validate zero enum value in Protocol Buffer</a></div><nav id="TableOfContents"><ul><li><ul><li><a href="#lets-talk-about-enum-and-some-problems-that-we-encountered-recently-with-it-div-classaltlets-talk-about-enumb">Let&rsquo;s talk about enum and some problems that we encountered recently with it.<div class="alt">Let&rsquo;s talk about enum</div></a></li><li><a href="#well-why-not-just-verify-that-all-enum-fields-are-not-set-to-0-in-webhook-messages-you-may-ask-div-classalttry-checking-for-zero-valueb">Well, why not just verify that all enum fields are not set to 0 in webhook messages? You may ask.<div class="alt">Try checking for zero value</div></a></li><li><a href="#so-how-to-validate-zero-value-in-enum-fields-div-classaltprevent-zero-value-in-enum-fieldsb">So, how to validate zero value in enum fields?<div class="alt">Prevent zero value in enum fields</div></a></li></ul></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fproto.enum%2f&title=Validate%20zero%20enum%20value%20in%20Protocol%20Buffer"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fproto.enum%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fproto.enum%2f&text=Validate%20zero%20enum%20value%20in%20Protocol%20Buffer"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fproto.enum%2f&title=Validate%20zero%20enum%20value%20in%20Protocol%20Buffer"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fproto.enum%2f&t=Validate%20zero%20enum%20value%20in%20Protocol%20Buffer"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>