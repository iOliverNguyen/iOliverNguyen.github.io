<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Zero2Prod: Day 3 – Setup database and sqlx | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Zero2Prod: Day 3 – Setup database and sqlx"><meta property="og:description" content="Database clients  tokio-postgres sqlx : use procedural macros to connect to database and verify the query at compile time diesel, macro.table : use cli to generate database schema in Rust code   Threads are for working in parallel, async is for waiting in parallel.
    Crate Query interface Compile-time safety Async     tokio-postgres SQL No Yes   sqlx SQL Yes Yes   diesel DSL Yes No    Docker Setup run scripts"><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/z2p.3/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2024-08-31T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-31T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="Zero2Prod: Day 3 – Setup database and sqlx"><meta name="twitter:description" content="Database clients  tokio-postgres sqlx : use procedural macros to connect to database and verify the query at compile time diesel, macro.table : use cli to generate database schema in Rust code   Threads are for working in parallel, async is for waiting in parallel.
    Crate Query interface Compile-time safety Async     tokio-postgres SQL No Yes   sqlx SQL Yes Yes   diesel DSL Yes No    Docker Setup run scripts"><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/z2p.3/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Zero2Prod: Day 3 – Setup database and sqlx</h1><div class="meta"><div class="postdate"><time datetime="2024-08-31 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-08-31</time></div><div class="article-tag">&nbsp;· <a class="tag-link" href="/w/#rust" rel="tag">rust</a></div></div></header><div class="content" itemprop="articleBody"><h2 id="database-clients">Database clients</h2><ul><li><a href="https://docs.rs/tokio-postgres/latest/tokio_postgres/">tokio-postgres</a></li><li><a href="https://docs.rs/sqlx/latest/sqlx/">sqlx</a> : use procedural macros to connect to database and verify the query at compile time</li><li><a href="https://docs.rs/diesel/latest/diesel/">diesel</a>, <a href="https://docs.diesel.rs/1.4.x/diesel/macro.table.html">macro.table</a> : use cli to generate database schema in Rust code</li></ul><blockquote><p>Threads are for working in parallel, async is for waiting in parallel.</p></blockquote><table><thead><tr><th style="text-align:left">Crate</th><th style="text-align:center">Query interface</th><th style="text-align:center">Compile-time safety</th><th style="text-align:center">Async</th></tr></thead><tbody><tr><td style="text-align:left">tokio-postgres</td><td style="text-align:center">SQL</td><td style="text-align:center">No</td><td style="text-align:center">Yes</td></tr><tr><td style="text-align:left">sqlx</td><td style="text-align:center">SQL</td><td style="text-align:center">Yes</td><td style="text-align:center">Yes</td></tr><tr><td style="text-align:left">diesel</td><td style="text-align:center">DSL</td><td style="text-align:center">Yes</td><td style="text-align:center">No</td></tr></tbody></table><h2 id="docker">Docker</h2><p>Setup <a href="https://olivernguyen.io/w/direnv.run/">run scripts</a></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nb">set</span> -eo pipefail

run-start-docker<span class="o">()</span> <span class="o">{</span>
    docker compose up -d
<span class="o">}</span>

<span class="c1"># -------- this is the magic ------- #</span>
<span class="nb">source</span> <span class="s2">&#34;</span><span class="nv">$PROJECT_ROOT</span><span class="s2">/scripts/_cli.sh&#34;</span>
</code></pre></div><p>docker-compose.yml</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">postgres</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">postgres</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">newsletter-db</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">POSTGRES_USER</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${DB_USER:?}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${DB_PASSWORD:?}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">POSTGRES_DB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${DB_NAME:?}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;${DB_PORT}:5432&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">newsletter-db-data:/var/lib/postgresql/data</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;postgres&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-N&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1000&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="c"># ^ Increased maximum number of connections for testing purposes</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">newsletter-db-data</span><span class="p">:</span><span class="w">
</span></code></pre></div><p>.env</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">DB_USER</span><span class="o">=</span>postgres
<span class="nv">DB_PASSWORD</span><span class="o">=</span>magic
<span class="nv">DB_NAME</span><span class="o">=</span>newsletter
<span class="nv">DB_PORT</span><span class="o">=</span><span class="m">5432</span>
</code></pre></div><p>.envrc</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span>  <span class="nv">PROJECT_ROOT</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-toplevel 2&gt;/dev/null<span class="k">)</span>
<span class="nb">export</span> <span class="nv">RELATIVE_PATH</span><span class="o">=</span><span class="k">$(</span>git rev-parse --show-prefix   2&gt;/dev/null<span class="k">)</span>

<span class="nb">source</span> .env
<span class="nb">export</span> <span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://<span class="si">${</span><span class="nv">DB_USER</span><span class="si">}</span>:<span class="si">${</span><span class="nv">DB_PASSWORD</span><span class="si">}</span>@localhost:<span class="si">${</span><span class="nv">DB_PORT</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DB_NAME</span><span class="si">}</span>

PATH_add <span class="s2">&#34;</span><span class="nv">$PWD</span><span class="s2">&#34;</span>
</code></pre></div><h2 id="sqlx">sqlx</h2><h3 id="install-sqlx-crate">Install <code>sqlx</code> crate</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">add sqlx --features<span class="o">=</span>runtime-tokio-rustls,macros,postgres,uuid,chrono,migrate
</code></pre></div><ul><li><strong>runtime-tokio-rustls</strong> tells sqlx to use the <code>tokio</code> runtime for its futures and <code>rustls</code> as TLS backend</li><li><strong>macros</strong> gives us access to <code>sqlx::query!</code> and <code>sqlx::query_as!</code>, which we will be using exten- sively</li><li><strong>postgres</strong> unlocks Postgres-specific functionality (e.g. non-standard SQL types)</li><li><strong>uuid</strong> adds support for mapping SQL UUIDs to the <code>Uuid</code> type from the <code>uuid</code> crate. We need it to work with our id column</li><li><strong>chrono</strong> adds support for mapping SQL timestamptz to the <code>DateTime&lt;T&gt;</code> type from the chrono crate. We need it to work with our subscribed_at column</li><li><strong>migrate</strong> gives us access to the same functions used under the hood by <strong>sqlx-cli</strong> to manage migrations. It will turn out to be useful for our test suite</li></ul><h3 id="using-the-cli">Using the cli</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sqlx database create
sqlx migrate add create_subscription_table
</code></pre></div><h3 id="config-crate"><code>config</code> crate</h3><p>It supports multiple file formats and it supports combining different sources hierarchically (e.g. environment variables, con-figuration files, etc.)</p><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#database-clients">Database clients</a></li>\n    <li><a href="#docker">Docker</a></li>\n    <li><a href="#sqlx">sqlx</a>\n      <ul>\n        <li><a href="#install-sqlx-crate">Install <code>sqlx</code> crate</a></li>\n        <li><a href="#using-the-cli">Using the cli</a></li>\n        <li><a href="#config-crate"><code>config</code> crate</a></li>\n      </ul>\n    </li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Zero2Prod: Day 3 – Setup database and sqlx</a></div><nav id="TableOfContents"><ul><li><a href="#database-clients">Database clients</a></li><li><a href="#docker">Docker</a></li><li><a href="#sqlx">sqlx</a><ul><li><a href="#install-sqlx-crate">Install <code>sqlx</code> crate</a></li><li><a href="#using-the-cli">Using the cli</a></li><li><a href="#config-crate"><code>config</code> crate</a></li></ul></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.3%2f&title=Zero2Prod%3a%20Day%203%20%e2%80%93%20Setup%20database%20and%20sqlx"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.3%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.3%2f&text=Zero2Prod%3a%20Day%203%20%e2%80%93%20Setup%20database%20and%20sqlx"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.3%2f&title=Zero2Prod%3a%20Day%203%20%e2%80%93%20Setup%20database%20and%20sqlx"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.3%2f&t=Zero2Prod%3a%20Day%203%20%e2%80%93%20Setup%20database%20and%20sqlx"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>