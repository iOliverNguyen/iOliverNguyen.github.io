<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Zero2Prod: Day 1 – Writing tests | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Zero2Prod: Day 1 – Writing tests"><meta property="og:description" content="Extract the app logic to a function asyncfn main()-&gt; std::io::Result&lt;()&gt;{let_=run().await?;Ok(())}pubfn run()-&gt; Result&lt;Server,std::io::Error&gt;{letserver=HttpServer::new(||create_app()).bind(&#34;127.0.0.1:8080&#34;)?.run();Ok(server)}fn create_app()-&gt; App&lt;implServiceFactory&lt;ServiceRequest,Config=(),Response=ServiceResponse,Error=actix_web::Error,InitError=(),&gt;,&gt;{App::new().route(&#34;/health&#34;,web::get().to(health)).route(&#34;/&#34;,web::get().to(greet)).route(&#34;/{name}&#34;,web::get().to(greet))} fn create_app() return an App that implements ServiceFactory trait. we need to provide all the type params: Response, Config, Error, InitError.  pubtraitServiceFactory&lt;Req&gt;{/// Responses given by the created services. type Response;/// Errors produced by the created services. type Error;/// Service factory configuration. type Config;/// The kind of `Service` created by this factory. type Service: Service&lt;Req,Response=Self::Response,Error=Self::Error&gt;;/// Errors potentially raised while building a service."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/z2p.1/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2024-08-29T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-29T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="Zero2Prod: Day 1 – Writing tests"><meta name="twitter:description" content="Extract the app logic to a function asyncfn main()-&gt; std::io::Result&lt;()&gt;{let_=run().await?;Ok(())}pubfn run()-&gt; Result&lt;Server,std::io::Error&gt;{letserver=HttpServer::new(||create_app()).bind(&#34;127.0.0.1:8080&#34;)?.run();Ok(server)}fn create_app()-&gt; App&lt;implServiceFactory&lt;ServiceRequest,Config=(),Response=ServiceResponse,Error=actix_web::Error,InitError=(),&gt;,&gt;{App::new().route(&#34;/health&#34;,web::get().to(health)).route(&#34;/&#34;,web::get().to(greet)).route(&#34;/{name}&#34;,web::get().to(greet))} fn create_app() return an App that implements ServiceFactory trait. we need to provide all the type params: Response, Config, Error, InitError.  pubtraitServiceFactory&lt;Req&gt;{/// Responses given by the created services. type Response;/// Errors produced by the created services. type Error;/// Service factory configuration. type Config;/// The kind of `Service` created by this factory. type Service: Service&lt;Req,Response=Self::Response,Error=Self::Error&gt;;/// Errors potentially raised while building a service."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/z2p.1/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Zero2Prod: Day 1 – Writing tests</h1><div class="meta"><div class="postdate"><time datetime="2024-08-29 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-08-29</time></div><div class="article-tag">&nbsp;· <a class="tag-link" href="/w/#rust" rel="tag">rust</a></div></div></header><div class="content" itemprop="articleBody"><h2 id="extract-the-app-logic-to-a-function">Extract the app logic to a function</h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Server</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpServer</span>::<span class="n">new</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">create_app</span><span class="p">())</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&#34;127.0.0.1:8080&#34;</span><span class="p">)</span><span class="o">?</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">server</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">create_app</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">App</span><span class="o">&lt;</span><span class="w">
</span><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">ServiceFactory</span><span class="o">&lt;</span><span class="w">
</span><span class="w">        </span><span class="n">ServiceRequest</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">Config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w">
</span><span class="w">        </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ServiceResponse</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actix_web</span>::<span class="n">Error</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">InitError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w">
</span><span class="w">    </span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">App</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&#34;/health&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">web</span>::<span class="n">get</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">health</span><span class="p">))</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">web</span>::<span class="n">get</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">greet</span><span class="p">))</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&#34;/{name}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">web</span>::<span class="n">get</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">greet</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><ul><li><code>fn create_app()</code> return an <code>App</code> that implements <code>ServiceFactory</code> trait.</li><li>we need to provide all the type params: <code>Response</code>, <code>Config</code>, <code>Error</code>, <code>InitError</code>.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">ServiceFactory</span><span class="o">&lt;</span><span class="n">Req</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Responses given by the created services.
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">Response</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Errors produced by the created services.
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">Error</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Service factory configuration.
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">Config</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// The kind of `Service` created by this factory.
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">Service</span>: <span class="nc">Service</span><span class="o">&lt;</span><span class="n">Req</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Errors potentially raised while building a service.
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">InitError</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// The future of the `Service` instance.g
</span><span class="sd"></span><span class="w">    </span><span class="k">type</span> <span class="nc">Future</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Service</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">InitError</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Create and return a new service asynchronously.
</span><span class="sd"></span><span class="w">    </span><span class="k">fn</span> <span class="nf">new_service</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">cfg</span>: <span class="nc">Self</span>::<span class="n">Config</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Future</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><h2 id="where-to-put-the-tests">Where to put the tests?</h2><p><strong>Next to our code in an embedded test module:</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="cp">#[cfg(test)]</span><span class="w">
</span><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="c1">// write tests here
</span><span class="c1"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p><strong>In an external tests folder:</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ls

src/
tests/
    health.rs
</code></pre></div><p><strong>As part of public documentation (doc tests):</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="sd">/// Check if a number is even.
</span><span class="sd">/// ```rust
</span><span class="sd">/// use zero2prod::is_even;
</span><span class="sd">///
</span><span class="sd">/// assert!(is_even(2));
</span><span class="sd">/// assert!(!is_even(1));
</span><span class="sd">/// ```
</span><span class="sd"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_even</span><span class="p">(</span><span class="n">x</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Execute with <code>cargo test</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cargo <span class="nb">test</span> --test health
</code></pre></div><h2 id="test-the-health-endpoint-with-actix_web">Test the /health endpoint with <code>actix_web</code></h2><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// main.rs
</span><span class="c1"></span><span class="w">
</span><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">health</span><span class="p">(</span><span class="n">req</span>: <span class="nc">HttpRequest</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Responder</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">HttpResponse</span>::<span class="nb">Ok</span><span class="p">().</span><span class="n">json</span><span class="p">(</span><span class="n">json</span><span class="o">!</span><span class="p">({</span><span class="w"> </span><span class="s">&#34;status&#34;</span>: <span class="s">&#34;ok&#34;</span><span class="w"> </span><span class="p">}))</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Write the first test using <code>actix_web::test</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// tests.rs
</span><span class="c1"></span><span class="w">
</span><span class="w"></span><span class="cp">#[cfg(test)]</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">health</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">App</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="p">{</span><span class="n">http</span>::<span class="n">StatusCode</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">web</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cp">#[actix_web::test]</span><span class="w">         </span><span class="c1">// 👈 macro
</span><span class="c1"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_health_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span>::<span class="n">init_service</span><span class="p">(</span><span class="w">
</span><span class="w">        </span><span class="n">create_app</span><span class="p">()</span><span class="w">       </span><span class="c1">// 👈 the app logic
</span><span class="c1"></span><span class="w">    </span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span>::<span class="n">TestRequest</span>::<span class="n">get</span><span class="p">().</span><span class="n">uri</span><span class="p">(</span><span class="s">&#34;/health&#34;</span><span class="p">).</span><span class="n">to_request</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span>::<span class="n">call_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">status</span><span class="p">(),</span><span class="w"> </span><span class="n">StatusCode</span>::<span class="n">OK</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c1">// test the response body
</span><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Failed to read response body&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="s">r#&#34;{&#34;status&#34;:&#34;ok&#34;}&#34;#</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><ul><li>We init the app by calling <code>create_app()</code> inside <code>test::init_service()</code>.</li><li>Create a request by <code>test::TestRequest::get()</code>.</li><li>Execute the request and get the response by <code>test::call_service(&amp;app, req).await</code>.</li></ul><h2 id="blackbox-test-the-health-endpoint">Blackbox test the /health endpoint</h2><p>Implement <code>spawn_app()</code>by using <code>tokio::spawn()</code></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">spawn_app</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newsletter</span>::<span class="n">run</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Failed to run newsletter&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="c1">// Start the server as background task
</span><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Write the test</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="cp">#[tokio::test]</span><span class="w">               </span><span class="c1">// 👈 macro
</span><span class="c1"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">health_test_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">spawn_app</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">Client</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:8080/health&#34;</span><span class="p">)</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">send</span><span class="p">()</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;Failed to send request&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">is_success</span><span class="p">());</span><span class="w">
</span><span class="w">    </span><span class="c1">// assert_eq!(response., Some(2));
</span><span class="c1"></span><span class="p">}</span><span class="w">
</span></code></pre></div><h3 id="use-random-port">Use random port</h3><ul><li>Use <code>TcpListener::bind(&quot;127.0.0.1:0&quot;)</code> to listen on a random port</li><li>And return that port to be used in the tests</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// Spawn the app on a random port
</span><span class="c1"></span><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpListener</span>::<span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;random port&#34;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listener</span><span class="p">.</span><span class="n">local_addr</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">port</span><span class="p">();</span><span class="w">
</span></code></pre></div><h3 id="notes">Notes</h3><ul><li><code>tokio::spawn</code> shutdown all tasks spawned when it are dropped.</li><li><code>tokio::test</code> spins up new runtime at the start of the test, and clean it up when the test ends</li></ul><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>and <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>.</span></p></div></article><div id="header-post"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a> <a id="menu-icon-tablet" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script>console.log("content",'<nav id="TableOfContents">\n  <ul>\n    <li><a href="#extract-the-app-logic-to-a-function">Extract the app logic to a function</a></li>\n    <li><a href="#where-to-put-the-tests">Where to put the tests?</a></li>\n    <li><a href="#test-the-health-endpoint-with-actix_web">Test the /health endpoint with <code>actix_web</code></a></li>\n    <li><a href="#blackbox-test-the-health-endpoint">Blackbox test the /health endpoint</a>\n      <ul>\n        <li><a href="#use-random-port">Use random port</a></li>\n        <li><a href="#notes">Notes</a></li>\n      </ul>\n    </li>\n  </ul>\n</nav>')</script><div class="toc-header"><a href="#">Zero2Prod: Day 1 – Writing tests</a></div><nav id="TableOfContents"><ul><li><a href="#extract-the-app-logic-to-a-function">Extract the app logic to a function</a></li><li><a href="#where-to-put-the-tests">Where to put the tests?</a></li><li><a href="#test-the-health-endpoint-with-actix_web">Test the /health endpoint with <code>actix_web</code></a></li><li><a href="#blackbox-test-the-health-endpoint">Blackbox test the /health endpoint</a><ul><li><a href="#use-random-port">Use random port</a></li><li><a href="#notes">Notes</a></li></ul></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.1%2f&title=Zero2Prod%3a%20Day%201%20%e2%80%93%20Writing%20tests"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.1%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.1%2f&text=Zero2Prod%3a%20Day%201%20%e2%80%93%20Writing%20tests"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.1%2f&title=Zero2Prod%3a%20Day%201%20%e2%80%93%20Writing%20tests"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fz2p.1%2f&t=Zero2Prod%3a%20Day%201%20%e2%80%93%20Writing%20tests"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2024 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>